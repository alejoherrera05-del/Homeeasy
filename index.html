<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<meta name="apple-mobile-web-app-title" content="HomeEasy">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/png" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#a6455a">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<title>HomeEasy | Gesti√≥n</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<style>
:root {
    --home-red: #a6455a;     /* NUEVO VINOTINTO */
    --home-yellow: #c2a468;  /* NUEVO DORADO PREMIUM */
    --brand-dark: #823646;   /* Fondo oscuro ajustado al nuevo vinotinto */
    --menu-bg: #f8f9fa; 
    
    --glass-bg: rgba(255,255,255,0.12);
    --glass-border: rgba(255,255,255,0.18);
}

/* =================================================
   1. ESTRUCTURA BASE
   ================================================= */
html {
    height: 100%;
    overscroll-behavior: none; 
    background-color: var(--home-red); 
}

body {
    margin: 0; padding: 0; 
    width: 100%; height: 100%; 
    background-color: var(--menu-bg);
    font-family: 'Montserrat', sans-serif;
    -webkit-font-smoothing: antialiased;
    overflow: hidden; 
    -webkit-tap-highlight-color: transparent;
}

/* =================================================
   2. EL TEL√ìN (INTRO HOMMY)
   ================================================= */
#intro-curtain {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 99999; 
    background: radial-gradient(circle at center, var(--home-red) 0%, var(--brand-dark) 100%);
    display: flex; justify-content: center; align-items: center;
    color: white;
    transition: opacity 0.8s ease, visibility 0.8s ease;
    opacity: 1;
    visibility: visible;
}

.curtain-hidden { opacity: 0 !important; visibility: hidden !important; pointer-events: none; }
.main-container { width: 100%; max-width: 420px; text-align: center; padding: 20px; }
.logo-triangulo { width:75px; margin-bottom:10px; }
.version-tag { font-size:.8rem; letter-spacing:2px; opacity:.7; margin-bottom:30px; }
.hommy-static { width:260px; margin-bottom:40px; }

.glass-loader {
    background: var(--glass-bg);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border); border-radius: 28px;
    padding: 25px; width: 100%; box-shadow: 0 25px 50px rgba(0,0,0,.25);
}
.status-pill { display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.2); padding:10px 18px; border-radius:40px; margin-bottom:15px; font-size: 0.9rem; font-weight: 600;}
.dot-spinner { width:10px; height:10px; background:var(--home-yellow); border-radius:50%; margin-right:10px; animation:pulse 1.5s infinite; }
@keyframes pulse{ 0%,100%{opacity:1} 50%{opacity:.4} }
.bar-container { width:100%; height:4px; background:rgba(255,255,255,.1); border-radius:10px; overflow:hidden; }
.bar-fill { height:100%; width:0%; background:var(--home-yellow); transition:width 1s ease-in-out; }

/* =================================================
   3. CAMPANA Y NOTIFICACIONES
   ================================================= */
.top-actions {
    position: fixed;
    top: env(safe-area-inset-top, 15px);
    right: 20px;
    z-index: 2000;
    margin-top: 15px;
}

.bell-container {
    position: relative; cursor: pointer; background: white; width: 45px; height: 45px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}
.bell-container i { font-size: 22px; color: var(--home-red); transition: color 0.3s; }
.notification-badge {
    position: absolute; top: -2px; right: -2px; background-color: var(--home-yellow); color: #fff; font-size: 10px; font-weight: bold;
    width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center; border: 2px solid #fff;
}
@keyframes ring { 0% { transform: rotate(0); } 10% { transform: rotate(15deg); } 20% { transform: rotate(-10deg); } 30% { transform: rotate(10deg); } 40% { transform: rotate(-10deg); } 50% { transform: rotate(0); } 100% { transform: rotate(0); } }
.ringing { animation: ring 2s infinite; color: var(--home-yellow) !important; }

.glass-bubble {
    display: none; position: absolute; top: 55px; right: 0px; width: 260px; max-height: 350px; overflow-y: auto;
    background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); padding: 15px; animation: fadeIn 0.2s ease-out;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.glass-bubble h6 { font-size: 0.85rem; font-weight: 700; color: var(--home-red); margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
.noti-item { margin-bottom: 8px; border-left: 4px solid var(--home-yellow); padding: 8px; background: rgba(255,255,255,0.6); border-radius: 6px; text-align: left; }
.noti-time { font-size: 0.7rem; font-weight: 700; margin-bottom: 2px; }
.noti-title { font-size: 0.8rem; color: #333; line-height: 1.2; font-weight: 600;}

/* =================================================
   4. EL ESCENARIO (MEN√ö TARJETAS PREMIUM)
   ================================================= */
#app-scroll-wrapper {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; 
    padding-top: env(safe-area-inset-top); display: flex; flex-direction: column; align-items: center;
}
#app-scroll-wrapper::-webkit-scrollbar { display: none; }
#app-scroll-wrapper { -ms-overflow-style: none; scrollbar-width: none; }

.menu-container { width: 100%; max-width: 420px; text-align: center; padding: 20px; margin-top: auto; margin-bottom: auto; }

/* --- LOGO LIMPIO --- */
.header-container { margin-bottom: 40px; }
.logo-img { width: 180px; display: block; margin: 0 auto; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.05)); }

.status-online { 
    display: inline-flex; align-items: center; justify-content: center; margin-top: 15px; padding: 6px 14px; 
    border-radius: 50px; background: rgba(46, 204, 113, 0.08); border: 1px solid rgba(46, 204, 113, 0.2);
    font-size: 0.65rem; font-weight: 700; letter-spacing: 1px; color: #27ae60; 
}
.pulse-green { width: 6px; height: 6px; background: #2ecc71; border-radius: 50%; margin-right: 8px; position: relative; box-shadow: 0 0 8px rgba(46, 204, 113, 0.6); }
.pulse-green::after { content: ""; position: absolute; width: 100%; height: 100%; background: #2ecc71; border-radius: 50%; animation: premium-pulse 2s infinite; }
@keyframes premium-pulse{ 0%{transform:scale(1);opacity:.8} 100%{transform:scale(2.5);opacity:0} }

/* --- CONTENEDOR DE TARJETAS --- */
.cards-wrapper {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* --- ANIMACI√ìN PREMIUM DE TARJETAS T√ÅCTILES --- */
.menu-card { 
    background: white; border-radius: 18px; padding: 20px; 
    display: flex; align-items: center; text-decoration: none; color: #333; 
    box-shadow: 0 10px 25px rgba(0,0,0,.04); border-left: 6px solid transparent; 
    position: relative; overflow: hidden; 
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); 
    -webkit-tap-highlight-color: transparent; 
}

.menu-card:active { 
    transform: scale(0.94); 
    box-shadow: 0 2px 8px rgba(0,0,0,.1); 
}
.menu-card::after { 
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(166, 69, 90, 0.1); 
    opacity: 0; transition: opacity 0.15s ease; pointer-events: none; 
}
.menu-card:active::after { opacity: 1; }

.icon-box { width:55px; height:55px; min-width: 55px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:1.4rem; margin-right:18px; background:var(--home-red); color:white; transition: all 0.3s ease;}
.menu-text { text-align:left; }
.menu-text h3 { margin:0; font-size:1rem; font-weight:800; color:var(--home-red); transition: all 0.3s ease;}
.menu-text p { margin:3px 0 0; font-size:.8rem; color:#777; }

/* Tarjetas Doradas */
.gold-card .icon-box { background:var(--home-yellow); }
.gold-card .menu-text h3 { color:var(--home-yellow); }

/* Tarjeta Destacada Calendario */
.calendar-card { 
    border: 2px solid var(--home-red); 
    background: linear-gradient(to right, #ffffff, #fffdfd); 
}
.calendar-card .icon-box { background: var(--home-red); }
.calendar-card .menu-text h3 { color: var(--home-red); }

/* =========================================
   PIE DE P√ÅGINA 
   ========================================= */
.app-footer {
    width: 100%; background-color: #ffffff; padding: 15px 0; padding-bottom: calc(15px + env(safe-area-inset-bottom));
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.04); border-top-left-radius: 25px; border-top-right-radius: 25px;
    flex-shrink: 0; z-index: 20; gap: 3px; 
}
.footer-logo { height: 38px; width: auto; object-fit: contain; margin-bottom: 2px; }
.footer-title { font-size: 0.85rem; font-weight: 600; color: #333333; }
.footer-version { font-size: 0.7rem; color: #888888; font-weight: 500; letter-spacing: 0.5px; }

/* =================================================
   üñ•Ô∏è RESPONSIVE DESKTOP Y EFECTOS HOVER 
   ================================================= */
@media (hover: hover) and (pointer: fine) {
    .menu-card:hover { 
        transform: translateY(-5px) scale(1.02); 
        box-shadow: 0 15px 35px rgba(0,0,0,0.08); 
        border-left-color: var(--home-red);
    }
    .gold-card:hover { border-left-color: var(--home-yellow); }
    .calendar-card:hover { box-shadow: 0 15px 35px rgba(166, 69, 90, 0.15); }
}

@media (min-width: 768px) {
    .menu-container { max-width: 800px; padding-top: 40px; }
    .cards-wrapper { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
    .menu-card { margin-bottom: 0; height: 100%; }
    .calendar-card { grid-column: 1 / -1; justify-content: center; }
}

/* ==========================================================
   üö® NUEVO: VENTANITAS BONITAS (BOTTOM SHEETS ESTILO iOS)
   ========================================================== */
.bottom-sheet-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    z-index: 9999; opacity: 0; visibility: hidden;
    transition: all 0.3s ease;
    display: flex; align-items: flex-end;
}
.bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
.bottom-sheet-content {
    background: white; width: 100%;
    border-radius: 30px 30px 0 0;
    padding: 25px 25px calc(40px + env(safe-area-inset-bottom));
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
    box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
}
.bottom-sheet-overlay.active .bottom-sheet-content { transform: translateY(0); }
.sheet-handle {
    width: 40px; height: 5px; background: #ddd;
    border-radius: 10px; margin: 0 auto 20px;
}
.sheet-title {
    font-weight: 800; color: #333; font-size: 1.3rem; 
    text-align: left; margin-bottom: 5px;
}
.sheet-desc {
    font-size: 0.85rem; color: #888; font-weight: 500;
    text-align: left; margin-bottom: 25px;
}
.sheet-btn {
    display: flex; align-items: center; gap: 15px;
    background: #f8f9fa; border: 1px solid #f0f0f0;
    padding: 15px 20px; border-radius: 20px;
    margin-bottom: 15px; color: #333; text-decoration: none;
    font-weight: 700; font-size: 1.05rem;
    transition: all 0.2s;
}
.sheet-btn:active { background: #eee; transform: scale(0.98); }
.sheet-btn:last-child { margin-bottom: 0; }
.sheet-btn .icon-wrapper {
    width: 45px; height: 45px; border-radius: 14px;
    display: flex; justify-content: center; align-items: center;
    font-size: 1.3rem;
}
.sheet-btn-wine .icon-wrapper { background: rgba(166, 69, 90, 0.1); color: var(--home-red); }
.sheet-btn-gold .icon-wrapper { background: rgba(194, 164, 104, 0.15); color: var(--home-yellow); }
.sheet-btn-blue .icon-wrapper { background: rgba(52, 152, 219, 0.1); color: #3498db; }
.sheet-btn-green .icon-wrapper { background: rgba(46, 204, 113, 0.1); color: #27ae60; }
.sheet-btn-content { display: flex; flex-direction: column; text-align: left; }
.sheet-btn-title { margin: 0; line-height: 1; }
.sheet-btn-subtitle { font-size: 0.7rem; color: #999; font-weight: 500; margin-top: 4px; }
</style>
</head>

<body ontouchstart="">

    <div id="intro-curtain">
        <div class="main-container">
            <img src="triangulogold.png" class="logo-triangulo" alt="Logo" onerror="this.src='triangulo.png'">
            <h1>HomeEasy</h1>
            <div class="version-tag">Sistema Hommy 2.0</div>
            
            <img src="hommysaludando.png" class="hommy-static" alt="Hommy" onerror="this.src='HOMMY.png'">
            
            <div class="glass-loader">
                <div class="status-pill">
                    <div class="dot-spinner"></div>
                    <div id="status-message">Iniciando sistema...</div>
                </div>
                <div class="bar-container">
                    <div class="bar-fill" id="progress-bar"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="top-actions" id="bell-wrapper">
        <div class="bell-container" onclick="toggleNotificationBubble(event)">
            <i class="fa-solid fa-bell" id="notification-bell-icon"></i>
            <span class="notification-badge" id="notification-badge">0</span>
        </div>
        <div class="glass-bubble" id="notification-bubble">
            <h6>
                Tareas para hoy
                <span class="material-icons-round" style="font-size: 16px; cursor:pointer;" onclick="toggleNotificationBubble(event)">close</span>
            </h6>
            <div id="notification-content"></div>
        </div>
    </div>

    <div id="app-scroll-wrapper">
        
        <div class="menu-container">
            
            <div class="header-container">
                <img src="logohomeeasy.png" class="logo-img" alt="HomeEasy Logo" onerror="this.src='triangulo.png'; this.style.width='80px'">
                <div class="status-online">
                    <div class="pulse-green"></div>
                    HOMMY | ONLINE
                </div>
            </div>

            <div class="cards-wrapper">
                <a href="clientes.html" class="menu-card">
                    <div class="icon-box"><i class="fa-solid fa-magnifying-glass"></i></div>
                    <div class="menu-text"><h3>Consultar cliente</h3><p>Datos e historial</p></div>
                </a>

                <a href="#" onclick="event.preventDefault(); openSheet('sheet-cotizacion')" class="menu-card gold-card">
                    <div class="icon-box"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                    <div class="menu-text"><h3>Cotizaci√≥n</h3><p>Formulario y Seguimiento</p></div>
                </a>

                <a href="#" onclick="event.preventDefault(); openSheet('sheet-pedido')" class="menu-card">
                    <div class="icon-box"><i class="fa-solid fa-clipboard-list"></i></div>
                    <div class="menu-text"><h3>Orden de pedido</h3><p>Formulario e Informes</p></div>
                </a>

                <a href="abono.html" class="menu-card gold-card">
                    <div class="icon-box"><i class="fa-solid fa-receipt"></i></div>
                    <div class="menu-text"><h3>Registrar abono</h3><p>Recibo de ingreso</p></div>
                </a>

                <a href="calendario.html" class="menu-card calendar-card">
                    <div class="icon-box"><i class="fa-solid fa-calendar-check"></i></div>
                    <div class="menu-text"><h3>Agenda & Calendario</h3><p>Crea y revisa compromisos</p></div>
                </a>
            </div>
            
        </div>

        <footer class="app-footer">
            <img src="Hommypiedepagina.png" alt="Logo Hommy" class="footer-logo">
            <div class="footer-title">HomeEasy - Sistema Hommy</div>
            <div class="footer-version">VERSI√ìN 2.0 &copy; 2026</div>
        </footer>

    </div>

<div class="bottom-sheet-overlay" id="sheet-cotizacion" onclick="closeSheet('sheet-cotizacion')">
    <div class="bottom-sheet-content" onclick="event.stopPropagation()">
        <div class="sheet-handle"></div>
        <h3 class="sheet-title">Cotizaciones</h3>
        <p class="sheet-desc">¬øQu√© deseas realizar?</p>

        <a href="cotizacion.html" class="sheet-btn sheet-btn-gold">
            <div class="icon-wrapper"><i class="fa-solid fa-pen-nib"></i></div>
            <div class="sheet-btn-content">
                <span class="sheet-btn-title">Formulario</span>
                <span class="sheet-btn-subtitle">Crear nueva cotizaci√≥n</span>
            </div>
        </a>

        <a href="seguimiento.html" class="sheet-btn sheet-btn-wine">
            <div class="icon-wrapper"><i class="fa-solid fa-crosshairs"></i></div>
            <div class="sheet-btn-content">
                <span class="sheet-btn-title">Seguimiento</span>
                <span class="sheet-btn-subtitle">Radar CRM y activas</span>
            </div>
        </a>
    </div>
</div>

<div class="bottom-sheet-overlay" id="sheet-pedido" onclick="closeSheet('sheet-pedido')">
    <div class="bottom-sheet-content" onclick="event.stopPropagation()">
        <div class="sheet-handle"></div>
        <h3 class="sheet-title">Orden de Pedido</h3>
        <p class="sheet-desc">¬øQu√© deseas realizar?</p>

        <a href="pedido.html" class="sheet-btn sheet-btn-wine">
            <div class="icon-wrapper"><i class="fa-solid fa-clipboard-check"></i></div>
            <div class="sheet-btn-content">
                <span class="sheet-btn-title">Formulario</span>
                <span class="sheet-btn-subtitle">Registrar nueva OP</span>
            </div>
        </a>

        <a href="reportes.html" class="sheet-btn sheet-btn-green">
            <div class="icon-wrapper"><i class="fa-solid fa-chart-pie"></i></div>
            <div class="sheet-btn-content">
                <span class="sheet-btn-title">Informes</span>
                <span class="sheet-btn-subtitle">Dashboard de ventas</span>
            </div>
        </a>
    </div>
</div>

<script>
// ==========================================
// üö® FUNCIONES DE LAS VENTANAS BONITAS
// ==========================================
function openSheet(id) {
    document.getElementById(id).classList.add('active');
    document.body.style.overflow = 'hidden'; 
}

function closeSheet(id) {
    document.getElementById(id).classList.remove('active');
    document.body.style.overflow = ''; 
}

// ==========================================
// üöÄ L√ìGICA DE NEGOCIO INTEGRADA
// ==========================================
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyZHaIe7hb28KKtaPBORASy_maSZ2co8dZFce44GQRiZGYg_6WoU7qn4qC-lYCQO6ZL/exec";
let appIniciada = false;

const guionCarga = [
    { tiempo: 100,  progreso: "18%", texto: "Hommy est√° despertando..." },
    { tiempo: 1500, progreso: "45%", texto: "Limpiando sus ojitos..." },
    { tiempo: 3000, progreso: "75%", texto: "Prepar√°ndose un caf√© virtual..." },
    { tiempo: 4500, progreso: "90%", texto: "Ajustando su gorra..." }
];

function closeIntro() {
    if (appIniciada) return;
    appIniciada = true;

    const curtain = document.getElementById("intro-curtain");
    const progressBar = document.getElementById("progress-bar");
    const statusMessage = document.getElementById("status-message");
    
    if(statusMessage) statusMessage.innerText = "¬°Hommy est√° listo!";
    if(progressBar) progressBar.style.width = "100%";
    
    setTimeout(() => {
        if(curtain) {
            curtain.classList.add("curtain-hidden");
            sessionStorage.setItem("APP_INIT_DONE", "true");
            actualizarCampana(); 
            setTimeout(() => { curtain.style.display = "none"; }, 1000);
        }
    }, 800);
}

function correrGuion() {
    const progressBar = document.getElementById("progress-bar");
    const statusMessage = document.getElementById("status-message");
    guionCarga.forEach(escena => {
        setTimeout(() => {
            if (!appIniciada) {
                if(statusMessage) statusMessage.innerText = escena.texto;
                if(progressBar) progressBar.style.width = escena.progreso;
            }
        }, escena.tiempo);
    });
}

document.addEventListener("DOMContentLoaded", function() {
    const curtain = document.getElementById("intro-curtain");

    if (sessionStorage.getItem("APP_INIT_DONE") === "true") {
        if(curtain) curtain.style.display = "none";
        actualizarCampana();
        return; 
    }

    correrGuion();
    setTimeout(() => { closeIntro(); }, 5500); 

    fetch(URL_SCRIPT + "?init=LOAD")
        .then(response => response.json())
        .then(data => {
            if (data.status === "ok") {
                const clientesObj = {};
                if(data.clientes){
                    for (let i = 1; i < data.clientes.length; i++) {
                        const c = data.clientes[i];
                        // üî• AQU√ç ESTABA EL ERROR: AHORA HOMMY MEMORIZA LOS 5 DATOS
                        if(c && c[0]) clientesObj[c[0]] = { cedula: c[0], nombre: c[1], telefono: c[2], email: c[3], direccion: c[4] };
                    }
                }
                const ordenesArr = [];
                if(data.ordenes){
                    for (let i = 1; i < data.ordenes.length; i++) {
                        const o = data.ordenes[i];
                        if(o) ordenesArr.push({ numero: o[1], cedula: o[2], nombre: o[3], total: o[6], saldo: o[10] });
                    }
                }
                localStorage.setItem("CACHE_CLIENTES", JSON.stringify(clientesObj));
                localStorage.setItem("CACHE_ORDENES", JSON.stringify(ordenesArr));
                
                return fetch(URL_SCRIPT + "?tipo=EVENTOS_TODOS");
            }
        })
        .then(response => response ? response.json() : null)
        .then(data => {
            if (data && data.eventos) {
                localStorage.setItem("CACHE_EVENTOS", JSON.stringify(data.eventos));
            }
            setTimeout(closeIntro, 500); 
        })
        .catch(err => { 
            console.error("‚ö†Ô∏è Error cargando cach√©:", err); 
            setTimeout(closeIntro, 1000);
        });
});

// ==========================================
// CAMPANA Y NOTIFICACIONES
// ==========================================
function getFechaLocal() {
    const d = new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function obtenerEventosDeHoy() {
    const cacheEventos = localStorage.getItem('CACHE_EVENTOS');
    let pendingToday = [];
    if (cacheEventos) {
        try {
            const eventos = JSON.parse(cacheEventos);
            const hoy = getFechaLocal();
            pendingToday = eventos.filter(ev => {
                if(!ev.fecha) return false;
                const fechaSolo = ev.fecha.split("T")[0];
                return fechaSolo === hoy && ev.estado === "PENDIENTE";
            });
        } catch(e) {}
    }
    return pendingToday;
}

function actualizarCampana() {
    const pendingToday = obtenerEventosDeHoy();
    const bellIcon = document.getElementById('notification-bell-icon');
    const badge = document.getElementById('notification-badge');

    if (pendingToday.length > 0) {
        bellIcon.classList.add('ringing');
        badge.style.display = 'flex';
        badge.innerText = pendingToday.length;
    } else {
        bellIcon.classList.remove('ringing');
        badge.style.display = 'none';
    }
}

function toggleNotificationBubble(e) {
    if(e) e.stopPropagation();
    const bubble = document.getElementById('notification-bubble');
    
    if (bubble.style.display === 'block') {
        bubble.style.display = 'none';
        return;
    }

    const pending = obtenerEventosDeHoy();
    const content = document.getElementById('notification-content');
    content.innerHTML = '';

    if (pending.length === 0) {
        content.innerHTML = `
            <div style="text-align: center; padding: 15px 0;">
                <i class="fa-solid fa-check-circle" style="font-size: 30px; color: #ddd; margin-bottom: 5px;"></i>
                <p style="font-size: 0.85rem; color: #888; margin:0;">No tienes pendientes hoy</p>
            </div>`;
    } else {
        pending.forEach(ev => {
            let color = "#888";
            let cat = (ev.categoria || "").toLowerCase();
            if (cat.includes("instalaci")) color = "var(--home-red)";
            else if (cat.includes("visita")) color = "var(--home-yellow)";
            else if (cat.includes("garant")) color = "#3498db";
            else if (cat.includes("recordatorio")) color = "#27ae60";
            else if (cat.includes("obligaci")) color = "#9b59b6";

            content.innerHTML += `
                <div class="noti-item" style="border-left-color: ${color};">
                    <div class="noti-time" style="color: ${color};">${ev.hora || "Sin hora"}</div>
                    <div class="noti-title">${ev.titulo}</div>
                </div>
            `;
        });
    }

    bubble.style.display = 'block';
}

document.addEventListener('click', function(event) {
    const bubble = document.getElementById('notification-bubble');
    const bellWrapper = document.getElementById('bell-wrapper');
    if (bubble && bubble.style.display === 'block' && !bellWrapper.contains(event.target)) {
        bubble.style.display = 'none';
    }
});

window.addEventListener('focus', actualizarCampana);

</script>
</body>
</html>
