<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Calendario - Sistema Hommy</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f8f9fa;
            --primary-wine: #a6455a;  
            --accent-gold: #c2a468;   
            --text-dark: #333333;
            --text-light: #888888;
            --white: #ffffff;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --danger: #e74c3c;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color); color: var(--text-dark);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* üö´ EVITAR ZOOM EN IPHONE Y ANDROID AL ESCRIBIR */
        input, select, textarea { font-size: 16px !important; }

        /* --- Header Premium --- */
        header {
            background-color: var(--white);
            padding: calc(15px + env(safe-area-inset-top)) 20px 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.04); z-index: 10; position: relative; 
        }

        .header-left { z-index: 2; }

        /* BOT√ìN DE RETROCESO (IGUAL A COTIZACIONES Y √ìRDENES) */
        .btn-back { 
            background: rgba(166, 69, 90, 0.08); backdrop-filter: blur(5px);
            border-radius: 50%; width: 45px; height: 45px; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); color: var(--primary-wine); 
            text-decoration: none; font-size: 1.2rem; transition: transform 0.2s;
        }
        .btn-back:active { transform: scale(0.9); background: rgba(166, 69, 90, 0.15); }

        .header-center {
            position: absolute; left: 50%; transform: translateX(-50%);
            z-index: 1; width: 60%; display: flex; justify-content: center;
        }

        .header-brand {
            display: flex; align-items: center; gap: 8px; white-space: nowrap; 
        }

        .header-brand img { height: 24px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .header-brand h1 { font-size: 1.1rem; color: var(--primary-wine); font-weight: 700; margin: 0; letter-spacing: -0.5px;}

        .header-icons { display: flex; gap: 15px; z-index: 2; }
        .header-icons span { color: var(--primary-wine); font-size: 24px; cursor: pointer; padding: 5px; }

        /* --- Calendario con Swipe --- */
        .calendar-container {
            background-color: var(--white); padding: 0 20px 20px 20px;
            border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
            box-shadow: var(--shadow); z-index: 5;
            touch-action: pan-y; 
        }

        .month-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-top: 15px; }
        .month-header h2 { font-size: 1.1rem; color: var(--text-dark); font-weight: 600; text-transform: capitalize; }
        .month-nav { color: var(--accent-gold); cursor: pointer; font-size: 26px; padding: 5px; }

        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.75rem; color: var(--text-light); margin-bottom: 10px; font-weight: 600; }
        .days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; row-gap: 12px; }
        .day { font-size: 0.95rem; cursor: pointer; position: relative; height: 38px; width: 38px; display: flex; justify-content: center; align-items: center; margin: 0 auto; border-radius: 50%; transition: 0.2s; font-weight: 500; }
        .day.active { background-color: var(--primary-wine); color: var(--white); font-weight: 700; box-shadow: 0 4px 10px rgba(166, 69, 90, 0.35); }
        .day.has-event::after { content: ''; position: absolute; bottom: 4px; width: 5px; height: 5px; background-color: var(--accent-gold); border-radius: 50%; }
        .day.active.has-event::after { background-color: var(--white); }

        /* --- Agenda Section --- */
        .agenda-container { flex: 1; padding: 20px; padding-bottom: 110px; overflow-y: auto; }
        .agenda-header { 
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.95rem; color: var(--primary-wine); margin-bottom: 15px; font-weight: 700; text-transform: capitalize; border-bottom: 1px dashed #e0e0e0; padding-bottom: 8px; 
        }

        /* Bot√≥n Deshacer */
        #undoContainer {
            display: none; align-items: center; gap: 5px; cursor: pointer;
            color: var(--primary-wine); font-weight: 600; font-size: 0.75rem;
            background: rgba(166, 69, 90, 0.1); padding: 4px 10px; border-radius: 20px;
            transition: all 0.3s;
        }
        #undoContainer:active { transform: scale(0.95); background: rgba(166, 69, 90, 0.2); }

        /* --- TAREAS VENCIDAS --- */
        #vencidosWrapper { margin-bottom: 20px; background: var(--white); border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.08); border: 1px solid rgba(231, 76, 60, 0.15); }
        .vencidos-toggle { display: flex; justify-content: space-between; align-items: center; padding: 15px 18px; cursor: pointer; background: linear-gradient(to right, #fffafa, #ffffff); border-bottom: 1px solid rgba(231, 76, 60, 0.05); }
        .vencidos-toggle .label-box { display: flex; align-items: center; gap: 8px; color: var(--danger); font-weight: 600; font-size: 0.9rem; }
        .vencidos-count { background: var(--danger); color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; margin-left: 5px; }
        .vencidos-container { display: block; padding: 10px 15px; background-color: #fafafa; }
        .vencidos-container.collapsed { display: none; }

        /* ==== TARJETAS EVENTOS ==== */
        .evento-swipe-wrapper { position: relative; overflow: hidden; border-radius: 12px; margin-bottom: 12px; background-color: #FF3B30; box-shadow: 0 2px 10px rgba(0,0,0,0.04); transition: transform 0.4s ease; }
        .evento-accion-borrar { position: absolute; top: 0; right: 0; bottom: 0; width: 80px; display: flex; align-items: center; justify-content: center; color: white; }
        
        .evento-card-content { position: relative; z-index: 1; background-color: #FFFFFF; padding: 18px 16px; border-radius: 12px; width: 100%; box-sizing: border-box; display: flex; align-items: center; border-left: 5px solid transparent; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.4s ease; }
        .evento-card-content.vencido { border-left: 5px solid var(--danger) !important; background-color: var(--white) !important; border: 1px solid #f0f0f0 !important; }
        .evento-card-content.completed { background-color: #f5f5f5 !important; border-left-color: #dcdcdc !important; opacity: 0.8 !important; }
        .evento-card-content.completed * { text-decoration: line-through !important; color: #a0a0a0 !important; }

        .event-time { font-size: 0.85rem; font-weight: 700; color: var(--primary-wine); min-width: 65px; margin-right: 15px; text-align: center; }
        .event-details { flex: 1; }
        .event-details h3 { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.5px;}
        .event-details p { font-size: 0.8rem; margin-bottom: 2px; line-height: 1.3; color: var(--text-dark); }
        .event-details p.titulo-tarea { font-size: 0.95rem; font-weight: 600; margin-bottom: 4px; }
        
        .nota-box { font-size: 0.75rem; color: #666; font-style: italic; background: #fdfdfd; padding: 6px 10px; border-radius: 6px; margin-top: 6px; border-left: 2px solid var(--accent-gold); display: block; }
        .vencido-badge { color: var(--danger); font-size: 10px; font-weight: 700; text-transform: uppercase; display: inline-block; margin-top: 4px; background: rgba(231, 76, 60, 0.08); padding: 4px 8px; border-radius: 6px; }

        /* Tipos de eventos */
        .type-instalacion { border-left-color: var(--primary-wine); }
        .type-visita { border-left-color: var(--accent-gold); }
        .type-garantia { border-left-color: #3498db; }
        .type-recordatorio { border-left-color: #27ae60; }
        .type-obligacion { border-left-color: #9b59b6; }
        .cat-instalacion { color: var(--primary-wine); font-weight: 600; }
        .cat-visita { color: var(--accent-gold); font-weight: 600; }

        /* =========================================
           BOT√ìN FLOTANTE (CON ANIMACI√ìN ESTEROIDES)
           ========================================= */
        .fab {
            position: fixed; bottom: 95px; right: 20px; width: 60px; height: 60px;
            background: linear-gradient(135deg, var(--accent-gold), #b39556); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: var(--white); box-shadow: 0 4px 20px rgba(194, 164, 104, 0.5);
            z-index: 100; cursor: pointer;
            animation: pulse-steroids 2s infinite; /* REGRESARON LOS ESTEROIDES */
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .fab:active { transform: scale(0.9); }
        .fab .material-icons-round { font-size: 32px; }

        @keyframes pulse-steroids {
            0% { box-shadow: 0 0 0 0 rgba(194, 164, 104, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(194, 164, 104, 0); }
            100% { box-shadow: 0 0 0 0 rgba(194, 164, 104, 0); }
        }

        /* =========================================
           PIE DE P√ÅGINA 
           ========================================= */
        .app-footer {
            background-color: var(--white); padding: 15px 0; padding-bottom: calc(15px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.04); border-top-left-radius: 25px; border-top-right-radius: 25px;
            z-index: 20; position: fixed; bottom: 0; width: 100%;
        }
        .footer-logo { height: 32px; width: auto; margin-bottom: 2px; }
        .footer-title { font-size: 0.8rem; font-weight: 600; color: var(--text-dark); }
        .footer-version { font-size: 0.65rem; color: var(--text-light); font-weight: 500; letter-spacing: 0.5px; }

        /* Modales */
        .fullscreen-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-color); z-index: 3000; flex-direction: column; }
        .fs-header { background: var(--white); padding: calc(15px + env(safe-area-inset-top)) 20px 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .fs-header input { flex: 1; border: none; outline: none; font-size: 1rem; background: #f0f0f0; padding: 10px 15px; border-radius: 20px; color: var(--text-dark); }
        .fs-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* T√≠tulos Pr√≥ximas Tareas en Vinotinto */
        .group-header {
            font-size: 0.75rem; font-weight: 800; color: var(--primary-wine);
            text-transform: uppercase; letter-spacing: 2px;
            margin: 25px 0 10px 0; border-bottom: 1px dashed rgba(166, 69, 90, 0.2); padding-bottom: 5px;
        }
        .group-header:first-child { margin-top: 0; }

        /* Modal Evento Nuevo / Edici√≥n */
        .modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--white); width: 85%; max-width: 400px; border-radius: 20px; padding: 25px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-light); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 12px; outline: none; font-weight: 500; color: var(--text-dark); transition: border 0.3s; background: #fafafa; }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--accent-gold); background: #fff;}
        .form-group textarea { resize: none; }
        
        .btn-submit { background-color: var(--primary-wine); color: var(--white); border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: 700; margin-top: 10px; font-size: 1rem; box-shadow: 0 5px 15px rgba(166, 69, 90, 0.2);}
        .btn-submit:active { transform: scale(0.98); }
        .btn-cancel { background: transparent; color: var(--text-light); border: none; width: 100%; padding: 10px; font-weight: 600; margin-top: 5px; }

        @media (max-width: 380px) {
            .header-brand h1 { font-size: 0.95rem; }
            .header-brand img { height: 20px; }
            .fab { bottom: 85px; width: 50px; height: 50px; }
            .fab .material-icons-round { font-size: 28px; }
        }

        .sugerencias-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 10px 10px; z-index: 1000; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
        .sugerencia-item { padding: 10px; font-size: 0.85rem; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <a href="index.html" class="btn-back"><i class="fas fa-arrow-left"></i></a>
        </div>
        <div class="header-center">
            <div class="header-brand">
                <img src="triangulogold.png" alt="Logo">
                <h1>Agenda HomeEasy</h1>
            </div>
        </div>
        <div class="header-icons">
            <span class="material-icons-round" onclick="abrirBuscador()">search</span>
            <span class="material-icons-round" onclick="abrirProximos()">upcoming</span>
        </div>
    </header>

    <div class="calendar-container" id="swipeCalendarZone">
        <div class="month-header">
            <span class="material-icons-round month-nav" onclick="changeMonth(-1)">chevron_left</span>
           <h2 id="currentMonthYear"></h2>
            <span class="material-icons-round month-nav" onclick="changeMonth(1)">chevron_right</span>
        </div>
        <div class="weekdays">
            <div>D</div><div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div>
        </div>
        <div class="days" id="calendarDays"></div>
    </div>

    <div class="agenda-container">
        <div class="agenda-header">
            <span id="selectedDateText">Hoy</span>
            <div id="undoContainer" onclick="deshacerBorrado()">
                <i class="fas fa-undo-alt"></i> Deshacer
            </div>
        </div>
        <div class="events-container"></div>
    </div>

    <div class="fab" onclick="abrirNuevoEvento()">
        <span class="material-icons-round">add</span>
    </div>

    <footer class="app-footer">
        <img src="Hommypiedepagina.png" alt="Logo Hommy" class="footer-logo">
        <div class="footer-title">HomeEasy - Sistema Hommy</div>
        <div class="footer-version">VERSI√ìN 2.0 &copy; 2026</div>
    </footer>

    <div class="fullscreen-modal" id="searchModal">
        <div class="fs-header">
            <span class="material-icons-round" onclick="cerrarBuscador()" style="cursor:pointer; color: var(--primary-wine); font-size: 28px;">arrow_back</span>
            <input type="text" id="searchInput" placeholder="Buscar t√≠tulo, cliente, categor√≠a..." oninput="filtrarBusqueda(this.value)">
        </div>
        <div class="fs-content" id="searchResults">
            <p style="text-align:center; color:#bbb; margin-top:20px; font-size:0.9rem;">Escribe para buscar cualquier tarea...</p>
        </div>
    </div>

    <div class="fullscreen-modal" id="upcomingModal">
        <div class="fs-header">
            <span class="material-icons-round" onclick="cerrarProximos()" style="cursor:pointer; color: var(--primary-wine); font-size: 28px;">arrow_back</span>
            <h2 style="font-size: 1.1rem; color: var(--primary-wine); margin-left: 10px; font-weight: 700;">Pr√≥ximas Tareas</h2>
        </div>
        <div class="fs-content" id="upcomingResults"></div>
    </div>

    <div class="modal" id="eventModal">
        <div class="modal-content">
            <h2 id="modalTitle" style="color: var(--primary-wine); font-weight: 800; font-size: 1.3rem; margin-bottom: 20px; text-align: center;">Nuevo Evento</h2>
            
            <div class="form-group">
                <label>Categor√≠a</label>
                <select id="eventType" onchange="manejarCambioCategoria()" style="font-weight: 700;">
                    <option value="" style="font-weight: normal;">Seleccionar categor√≠a...</option>
                    <option value="Instalaciones" style="color: #a6455a;">‚óè Instalaciones</option>
                    <option value="Visitas t√©cnicas" style="color: #c2a468;">‚óè Visitas t√©cnicas</option>
                    <option value="Garant√≠as" style="color: #3498db;">‚óè Garant√≠as</option>
                    <option value="Recordatorios de pago" style="color: #27ae60;">‚óè Recordatorios de pago</option>
                    <option value="Obligaciones tributarias" style="color: #9b59b6;">‚óè Obligaciones tributarias</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>T√≠tulo del Evento</label>
                <input type="text" id="eventTitle" placeholder="Ej: Entrega de Comedor">
            </div>

            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="eventDate">
            </div>
            <div class="form-group">
                <label>Hora</label>
                <input type="time" id="eventTimeRaw">
            </div>

            <div class="form-group">
                <label>¬øAlgo importante que a√±adir?</label>
                <textarea id="eventNota" placeholder="Ej: Detalles adicionales..." rows="2"></textarea>
            </div>

            <div id="recurrenteContainer" style="display:none; margin-bottom: 15px; padding: 12px; background: #fff8eb; border-radius: 10px; border: 1px dashed var(--accent-gold);">
                <label style="display:flex; align-items:center; gap:8px; font-size:13px; font-weight: 600; color: var(--accent-gold); cursor: pointer; text-transform: none;">
                    <input type="checkbox" id="mensualCheckbox" style="width: auto; transform: scale(1.3);">
                    Crear para cada mes (1 a√±o)
                </label>
            </div>

            <div id="usarClienteContainer" style="display:none; margin-bottom: 10px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:13px; text-transform: none;">
                    <input type="checkbox" id="usarClienteCheckbox" onchange="toggleCliente()" style="width: auto; transform: scale(1.3);">
                    Vincular con un Cliente
                </label>
            </div>

            <div id="seccionCliente" style="display: none; border-top: 1px dashed #eee; padding-top:15px;">
                <div class="form-group" style="position: relative;">
                    <label>Buscar Cliente</label>
                    <input type="text" id="clienteBusqueda" placeholder="Nombre o c√©dula..." oninput="buscarClienteApp(this.value)">
                    <div id="listaSugerencias" class="sugerencias-dropdown"></div>
                    <input type="hidden" id="clienteSeleccionadoId">
                </div>

                <div class="form-group" id="seccionReferencia" style="display: none;">
                    <label>Cotizaci√≥n / OP Asignada</label>
                    <select id="eventReferencia">
                        <option value="">Cargando referencias...</option>
                    </select>
                </div>
            </div>

            <button class="btn-submit" id="btnGuardarEvent" onclick="guardarEvento()">Guardar Agenda</button>
            <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
        </div>
    </div>

<script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyZHaIe7hb28KKtaPBORASy_maSZ2co8dZFce44GQRiZGYg_6WoU7qn4qC-lYCQO6ZL/exec";
    const date = new Date();
    const currentMonthYear = document.getElementById('currentMonthYear');
    const calendarDays = document.getElementById('calendarDays');
    const selectedDateText = document.getElementById('selectedDateText');
    const modal = document.getElementById('eventModal');

    const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    let diasConEventos = [];
    let fechaActiva = null;
    let eventosGlobales = []; 

    let isEditing = false;
    let editingEventId = null;
    
    // Variables para el Bot√≥n "Deshacer"
    let ultimoEventoBorrado = null;
    let undoTimeout = null;

    // ==========================================
    // GESTI√ìN DE HORAS (24h nativo <-> AM/PM)
    // ==========================================
    function formatTimeForSave(time24) {
        if(!time24) return "";
        let [h, m] = time24.split(':');
        h = parseInt(h, 10);
        let ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12;
        h = h ? h : 12; 
        return `${h}:${m} ${ampm}`;
    }

    function parseTimeTo24h(timeAMPM) {
        if(!timeAMPM) return "";
        let [time, ampm] = timeAMPM.split(' ');
        if(!time || !ampm) return timeAMPM; 
        let [h, m] = time.split(':');
        h = parseInt(h, 10);
        if (ampm.toUpperCase() === 'PM' && h < 12) h += 12;
        if (ampm.toUpperCase() === 'AM' && h === 12) h = 0;
        return `${h.toString().padStart(2, '0')}:${m}`;
    }

    function getFechaLocal() {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function comprobarSiEsVencido(fechaEv, horaEv, estado) {
        if (estado === "COMPLETADO") return false;
        const ahora = new Date();
        const fechaHoyStr = getFechaLocal();
        const fechaSolo = fechaEv.split("T")[0]; 

        if (fechaSolo < fechaHoyStr) return true;
        if (fechaSolo > fechaHoyStr) return false;

        if (fechaSolo === fechaHoyStr && horaEv) {
            let time24 = parseTimeTo24h(horaEv);
            if(time24) {
                let [h, m] = time24.split(':');
                const horaEvento = new Date();
                horaEvento.setHours(parseInt(h, 10), parseInt(m, 10), 0, 0);
                return horaEvento < ahora;
            }
        }
        return false;
    }

    function obtenerClasesCategoria(categoriaRaw) {
        let cat = (categoriaRaw || "").toLowerCase();
        let claseTipo = "";
        let claseCategoria = "";

        if (cat.includes("instalaci")) { claseTipo = "type-instalacion"; claseCategoria = "cat-instalacion"; }
        else if (cat.includes("visita")) { claseTipo = "type-visita"; claseCategoria = "cat-visita"; }
        else if (cat.includes("garant")) { claseTipo = "type-garantia"; claseCategoria = "cat-garantia"; }
        else if (cat.includes("recordatorio")) { claseTipo = "type-recordatorio"; claseCategoria = "cat-recordatorio"; }
        else if (cat.includes("obligaci")) { claseTipo = "type-obligacion"; claseCategoria = "cat-obligacion"; }
        
        return { claseTipo, claseCategoria };
    }

    function getReferenciaHtml(referenciaOriginal) {
        let refLimpia = referenciaOriginal || "";
        let notaHtml = "";
        let isRecurrente = refLimpia.includes("REC-");
        
        if (refLimpia.includes(" / Nota: ")) {
            let partes = refLimpia.split(" / Nota: ");
            refLimpia = partes[0];
            let notaTexto = partes[1].split(" | REC-")[0]; 
            if(notaTexto) notaHtml = `<div class="nota-box">üìå ${notaTexto}</div>`;
        }

        refLimpia = refLimpia.split(" | REC-")[0];

        let html = "";
        if (refLimpia && refLimpia !== 'N/A' && refLimpia !== 'VENTA DIRECTA') {
            html += `<p><strong>Ref:</strong> ${refLimpia}</p>`;
        }
        if (notaHtml) html += notaHtml;
        if (isRecurrente) {
            html += `<p style="color: var(--accent-gold); font-weight: 700; font-size: 0.7rem; margin-top:6px; display:flex; align-items:center; gap:4px;"><i class="fas fa-sync-alt"></i> Evento Mensual</p>`;
        }
        return html;
    }

    // ==========================================
    // SWIPE CALENDAR M√ìVIL
    // ==========================================
    const calZone = document.getElementById('swipeCalendarZone');
    let touchstartX = 0;
    let touchendX = 0;

    calZone.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, {passive: true});
    calZone.addEventListener('touchend', e => { 
        touchendX = e.changedTouches[0].screenX; 
        if (touchendX < touchstartX - 60) changeMonth(1); 
        if (touchendX > touchstartX + 60) changeMonth(-1); 
    });

    // ==========================================
    // INICIALIZAR Y RENDERIZAR
    // ==========================================
    async function inicializarCalendario() {
        const cacheEventos = localStorage.getItem('CACHE_EVENTOS');
        if (cacheEventos) {
            try {
                eventosGlobales = JSON.parse(cacheEventos);
                procesarEventosLocales();
            } catch(e) {}
        }

        try {
            const response = await fetch(`${WEBAPP_URL}?tipo=EVENTOS_TODOS`);
            const data = await response.json();
            if (data.eventos) {
                eventosGlobales = data.eventos;
                localStorage.setItem('CACHE_EVENTOS', JSON.stringify(eventosGlobales));
                procesarEventosLocales(); 
            }
        } catch(e) { console.log("Modo offline."); }
    }

    function procesarEventosLocales() {
        actualizarDiasConEventos();
        renderCalendar();
        
        const fechaHoy = fechaActiva || getFechaLocal();
        fechaActiva = fechaHoy;

        const [anio, mes, dia] = fechaHoy.split("-");
        const fechaObj = new Date(anio, mes - 1, dia);
        selectedDateText.innerText = fechaObj.toLocaleDateString("es-ES", { day: "2-digit", month: "long", year: "numeric" });
        
        renderizarVencidas();
        renderizarEventosDia(fechaHoy);
    }

    function actualizarDiasConEventos() {
        const mesActual = (date.getMonth() + 1).toString().padStart(2, "0");
        const anioActual = date.getFullYear().toString();
        
        diasConEventos = eventosGlobales
            .filter(ev => {
                if(!ev.fecha) return false;
                const [y, m] = ev.fecha.split("T")[0].split("-");
                return y === anioActual && m === mesActual && ev.estado !== "COMPLETADO";
            })
            .map(ev => ev.fecha.split("T")[0].split("-")[2]);
    }

    function renderCalendar() {
        date.setDate(1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        const firstDayIndex = date.getDay();
        currentMonthYear.innerHTML = `${months[date.getMonth()]} ${date.getFullYear()}`;
        let days = "";
        for (let x = 0; x < firstDayIndex; x++) { days += `<div></div>`; }
        for (let i = 1; i <= lastDay; i++) {
            const hoy = new Date();
            const esHoy = i === hoy.getDate() && date.getMonth() === hoy.getMonth() && date.getFullYear() === hoy.getFullYear();
            const diaFormateado = i.toString().padStart(2, "0");
            const tieneEvento = diasConEventos.includes(diaFormateado);
            days += `<div class="day ${esHoy ? 'active' : ''} ${tieneEvento ? 'has-event' : ''}" onclick="selectDay(this)">${i}</div>`;
        }
        calendarDays.innerHTML = days;
    }

    function changeMonth(n) {
        date.setMonth(date.getMonth() + n);
        actualizarDiasConEventos();
        renderCalendar();
    }

    function selectDay(element) {
        document.querySelectorAll('.day').forEach(d => d.classList.remove('active'));
        element.classList.add('active');

        const dia = element.innerText.padStart(2, "0");
        const mes = (date.getMonth() + 1).toString().padStart(2, "0");
        const anio = date.getFullYear();

        fechaActiva = `${anio}-${mes}-${dia}`;
        const fechaObj = new Date(fechaActiva + 'T00:00:00');

        selectedDateText.innerText = fechaObj.toLocaleDateString("es-ES", { day: "2-digit", month: "long", year: "numeric" });
        renderizarEventosDia(fechaActiva); 
    }

    function irAFecha(fechaStr) {
        cerrarBuscador();
        cerrarProximos();
        
        const [anio, mes, dia] = fechaStr.split("-");
        date.setFullYear(parseInt(anio));
        date.setMonth(parseInt(mes) - 1);
        
        actualizarDiasConEventos();
        renderCalendar();

        fechaActiva = fechaStr;
        const fechaObj = new Date(fechaActiva + 'T00:00:00');
        selectedDateText.innerText = fechaObj.toLocaleDateString("es-ES", { day: "2-digit", month: "long", year: "numeric" });

        document.querySelectorAll('.day').forEach(d => {
            d.classList.remove('active');
            if(d.innerText.padStart(2, "0") === dia) { d.classList.add('active'); }
        });
        renderizarEventosDia(fechaActiva);
    }

    // ==========================================
    // BUSCADORES Y PR√ìXIMAS TAREAS
    // ==========================================
    function abrirBuscador() {
        document.getElementById('searchModal').style.display = 'flex';
        document.getElementById('searchInput').focus();
    }
    
    function cerrarBuscador() {
        document.getElementById('searchModal').style.display = 'none';
        document.getElementById('searchInput').value = "";
    }

    function filtrarBusqueda(texto) {
        const contenedor = document.getElementById("searchResults");
        texto = texto.toLowerCase().trim();

        if (texto.length === 0) {
            contenedor.innerHTML = "<p style='text-align:center; color:#bbb; margin-top:20px; font-size:0.9rem;'>Escribe para buscar cualquier tarea...</p>";
            return;
        }

        const resultados = eventosGlobales.filter(ev => 
            (ev.titulo && ev.titulo.toLowerCase().includes(texto)) ||
            (ev.categoria && ev.categoria.toLowerCase().includes(texto)) ||
            (ev.cliente && ev.cliente.toLowerCase().includes(texto)) ||
            (ev.referencia && ev.referencia.toLowerCase().includes(texto))
        );

        if (resultados.length === 0) {
            contenedor.innerHTML = "<p style='text-align:center; color:#bbb; margin-top:20px; font-size:0.9rem;'>No se encontraron resultados.</p>";
            return;
        }

        contenedor.innerHTML = "";
        resultados.forEach(ev => {
            const { claseTipo, claseCategoria } = obtenerClasesCategoria(ev.categoria);
            const fechaFormateada = new Date(ev.fecha.split("T")[0] + 'T00:00:00').toLocaleDateString("es-ES", { day: "2-digit", month: "short", year:"numeric" });
            const estadoTexto = ev.estado === "COMPLETADO" ? " (Completada)" : "";

            const tarjeta = `
                <div class="evento-card-content ${claseTipo} ${ev.estado === 'COMPLETADO' ? 'completed' : ''}" onclick="irAFecha('${ev.fecha.split("T")[0]}')" style="margin-bottom:12px; cursor:pointer; box-shadow: var(--shadow); border: 1px solid #eee;">
                    <div class="event-details">
                        <div style="font-size: 0.75rem; color: var(--text-light); font-weight: 600; margin-bottom: 4px;"><i class="far fa-calendar-alt me-1"></i> ${fechaFormateada}${estadoTexto}</div>
                        <h3 class="${claseCategoria}" style="font-size: 0.8rem;">${ev.categoria}</h3>
                        <p class="titulo-tarea ${claseCategoria}" style="font-size: 0.95rem; margin-bottom: 2px;">${ev.titulo}</p>
                        ${ev.cliente && ev.cliente !== 'Sin asignar' ? `<p style="font-size:0.75rem; color:var(--text-dark);"><strong>C:</strong> ${ev.cliente}</p>` : ''}
                        ${getReferenciaHtml(ev.referencia)}
                    </div>
                    <span class="material-icons-round" style="color: #ddd;">chevron_right</span>
                </div>
            `;
            contenedor.innerHTML += tarjeta;
        });
    }

    function abrirProximos() {
        document.getElementById('upcomingModal').style.display = 'flex';
        const contenedor = document.getElementById("upcomingResults");
        contenedor.innerHTML = "";

        const hoy = new Date(getFechaLocal() + 'T00:00:00');
        
        let proximos = eventosGlobales.filter(ev => {
            if(!ev.fecha) return false;
            const evDateStr = ev.fecha.split("T")[0];
            return evDateStr >= getFechaLocal() && ev.estado === "PENDIENTE" && !comprobarSiEsVencido(ev.fecha, ev.hora, ev.estado);
        });

        proximos.sort((a, b) => a.fecha.localeCompare(b.fecha));
        proximos = proximos.slice(0, 30); 

        if(proximos.length === 0) {
            contenedor.innerHTML = "<p style='text-align:center; color:#bbb; margin-top:20px;'>Tu agenda est√° limpia. No hay tareas pr√≥ximas.</p>";
            return;
        }

        let groups = {};
        proximos.forEach(ev => {
            const evDate = new Date(ev.fecha.split("T")[0] + 'T00:00:00');
            const diffTime = evDate.getTime() - hoy.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            let groupName = "";
            if (diffDays === 0) groupName = "Hoy";
            else if (diffDays === 1) groupName = "Ma√±ana";
            else if (diffDays <= 7) groupName = "Pr√≥ximos 7 d√≠as";
            else if (diffDays <= 30) groupName = "Este Mes";
            else {
                const mes = evDate.toLocaleDateString("es-ES", { month: "long" });
                groupName = mes.charAt(0).toUpperCase() + mes.slice(1) + " " + evDate.getFullYear();
            }

            if(!groups[groupName]) groups[groupName] = [];
            groups[groupName].push(ev);
        });

        for(let key in groups) {
            contenedor.innerHTML += `<div class="group-header">${key}</div>`;
            groups[key].forEach(ev => {
                const { claseTipo, claseCategoria } = obtenerClasesCategoria(ev.categoria);
                const fechaFormateada = new Date(ev.fecha.split("T")[0] + 'T00:00:00').toLocaleDateString("es-ES", { day: "2-digit", month: "short" });

                const tarjeta = `
                    <div class="evento-card-content ${claseTipo}" onclick="irAFecha('${ev.fecha.split("T")[0]}')" style="margin-bottom:12px; cursor:pointer; box-shadow: var(--shadow); border: 1px solid #eee;">
                        <div class="event-details">
                            <div style="font-size: 0.75rem; color: var(--primary-wine); font-weight: 700; margin-bottom: 4px;"><i class="far fa-calendar-alt me-1"></i> ${fechaFormateada} &nbsp;|&nbsp; <i class="far fa-clock me-1"></i> ${ev.hora}</div>
                            <h3 class="${claseCategoria}" style="font-size: 0.8rem;">${ev.categoria}</h3>
                            <p class="titulo-tarea ${claseCategoria}" style="font-size: 0.95rem; margin-bottom: 0;">${ev.titulo}</p>
                            ${getReferenciaHtml(ev.referencia)}
                        </div>
                        <span class="material-icons-round" style="color: #ddd;">chevron_right</span>
                    </div>
                `;
                contenedor.innerHTML += tarjeta;
            });
        }
    }

    function cerrarProximos() { document.getElementById('upcomingModal').style.display = 'none'; }

    // ==========================================
    // RENDERIZADO PRINCIPAL
    // ==========================================
    function renderizarVencidas() {
        const agendaContainer = document.querySelector(".agenda-container");
        const existente = document.getElementById("vencidosWrapper");
        if (existente) existente.remove();

        const vencidos = eventosGlobales.filter(ev => ev.fecha && comprobarSiEsVencido(ev.fecha, ev.hora, ev.estado));
        if (vencidos.length === 0) return;

        const wrapper = document.createElement("div");
        wrapper.id = "vencidosWrapper";
        
        let htmlVencidos = `
            <div class="vencidos-toggle" onclick="toggleVencidos()">
                <div class="label-box">
                    <span class="material-icons-round" style="font-size: 20px;">error_outline</span>
                    <span>Tareas atrasadas</span>
                    <span class="vencidos-count">${vencidos.length}</span>
                </div>
                <span class="material-icons-round" id="vencidosIcon" style="color: var(--text-light);">keyboard_arrow_up</span>
            </div>
            <div class="vencidos-container" id="vencidosContainer">
        `;

        vencidos.forEach(ev => {
            const { claseTipo, claseCategoria } = obtenerClasesCategoria(ev.categoria);

            htmlVencidos += `
                <div class="evento-swipe-wrapper" id="evento-vencido-${ev.id}">
                    <div class="evento-accion-borrar"><span class="material-icons-round">delete</span></div>
                    <div class="evento-card-content vencido ${claseTipo}" onclick="abrirEdicion('${ev.id}')">
                        <div class="event-time">${ev.hora}</div>
                        <div class="event-details">
                            <h3 class="${claseCategoria}">${ev.categoria}</h3>
                            <p class="titulo-tarea ${claseCategoria}">${ev.titulo}</p>
                            ${ev.cliente && ev.cliente !== 'Sin asignar' ? `<p><strong>Cliente:</strong> ${ev.cliente}</p>` : ''}
                            ${getReferenciaHtml(ev.referencia)}
                            <span class="vencido-badge">¬°Atrasada!</span>
                        </div>
                        <span class="material-icons-round check-icon" style="color: var(--accent-gold); cursor:pointer; font-size: 28px; margin-left: auto;" onclick="event.stopPropagation(); animarYCompletar(this, '${ev.id}')">
                            check_circle
                        </span>
                    </div>
                </div>
            `;
        });

        htmlVencidos += `</div>`;
        wrapper.innerHTML = htmlVencidos;
        agendaContainer.insertBefore(wrapper, agendaContainer.firstChild);
        
        inicializarEventosSwipe();
    }

    function toggleVencidos() {
        const container = document.getElementById("vencidosContainer");
        const icon = document.getElementById("vencidosIcon");
        if (container) {
            const isCollapsed = container.classList.toggle("collapsed");
            icon.innerText = isCollapsed ? "keyboard_arrow_down" : "keyboard_arrow_up";
        }
    }

    function renderizarEventosDia(fecha) {
        const contenedor = document.querySelector(".events-container");
        contenedor.innerHTML = "";

        let eventosDelDia = eventosGlobales.filter(ev => ev.fecha && ev.fecha.split("T")[0] === fecha);

        if (eventosDelDia.length === 0) {
            contenedor.innerHTML = "<p style='text-align:center; color:#bbb; margin-top:20px; font-size:0.85rem;'>No hay eventos programados para hoy</p>";
            return;
        }
        
        eventosDelDia.sort((a, b) => {
            if (a.estado === "COMPLETADO" && b.estado !== "COMPLETADO") return 1;
            if (a.estado !== "COMPLETADO" && b.estado === "COMPLETADO") return -1;
            return 0; 
        });

        eventosDelDia.forEach(ev => {
            let esVencido = comprobarSiEsVencido(ev.fecha, ev.hora, ev.estado);
            if (esVencido && ev.estado === "PENDIENTE") return; 

            const claseEstado = ev.estado === "COMPLETADO" ? "completed" : "";
            const { claseTipo, claseCategoria } = obtenerClasesCategoria(ev.categoria);

            const tarjeta = `
            <div class="evento-swipe-wrapper ${claseEstado}" id="evento-${ev.id}">
                <div class="evento-accion-borrar"><span class="material-icons-round">delete</span></div>
                
                <div class="evento-card-content ${claseEstado} ${claseTipo}" onclick="${ev.estado !== 'COMPLETADO' ? `abrirEdicion('${ev.id}')` : ''}">
                    <div class="event-time">${ev.hora}</div>
                    
                    <div class="event-details">
                        <h3 class="${claseCategoria}">${ev.categoria}</h3>
                        <p class="titulo-tarea ${claseCategoria}">${ev.titulo}</p>
                        ${ev.cliente && ev.cliente !== 'Sin asignar' ? `<p><strong>Cliente:</strong> ${ev.cliente}</p>` : ''}
                        ${getReferenciaHtml(ev.referencia)}
                    </div>

                    ${ev.estado !== 'COMPLETADO' ? `
                        <span class="material-icons-round check-icon" style="color: var(--accent-gold); cursor:pointer; font-size: 28px; margin-left: auto;" onclick="event.stopPropagation(); animarYCompletar(this, '${ev.id}')">
                            check_circle
                        </span>
                    ` : ''}
                </div>
            </div>
            `;
            contenedor.innerHTML += tarjeta;
        });

        inicializarEventosSwipe();
    }

    async function animarYCompletar(iconoCheck, id) {
        const wrapper = iconoCheck.closest('.evento-swipe-wrapper');
        const content = wrapper.querySelector('.evento-card-content');
        const contenedorPadre = wrapper.parentElement;

        iconoCheck.style.transition = "transform 0.5s ease, opacity 0.5s ease";
        iconoCheck.style.transform = "scale(1.5) rotate(360deg)";
        iconoCheck.style.opacity = "0";

        setTimeout(() => {
            wrapper.classList.add('completed');
            content.classList.remove('vencido'); 
            content.classList.add('completed');
            content.onclick = null; 
            contenedorPadre.appendChild(wrapper);
            actualizarContadorVencidas(); 
        }, 350); 

        const evIndex = eventosGlobales.findIndex(e => String(e.id) === String(id));
        if(evIndex > -1) {
            eventosGlobales[evIndex].estado = "COMPLETADO";
            localStorage.setItem("CACHE_EVENTOS", JSON.stringify(eventosGlobales)); 
        }

        try {
            await fetch(WEBAPP_URL, { method: "POST", body: JSON.stringify({ tipo: "completar_evento", id: id }) });
        } catch (e) { console.error(e); }
    }

    function actualizarContadorVencidas() {
        const contenedor = document.getElementById("vencidosContainer");
        const countBadge = document.querySelector(".vencidos-count");
        const wrapper = document.getElementById("vencidosWrapper");

        if (contenedor && countBadge && wrapper) {
            const tareasRestantes = contenedor.querySelectorAll('.evento-swipe-wrapper:not(.completed)').length;
            countBadge.innerText = tareasRestantes;

            if (tareasRestantes === 0) {
                wrapper.style.transition = "all 0.4s ease"; wrapper.style.opacity = "0"; wrapper.style.height = "0px"; wrapper.style.marginBottom = "0px";
                setTimeout(() => wrapper.remove(), 400);
            }
        }
    }

    // ==========================================
    // NUEVO / EDICI√ìN DE EVENTOS 
    // ==========================================
    function abrirNuevoEvento() {
        isEditing = false;
        editingEventId = null;
        limpiarFormulario();
        document.getElementById('modalTitle').innerText = "Nuevo Evento";
        document.getElementById('eventDate').value = fechaActiva || getFechaLocal();
        document.getElementById('btnGuardarEvent').innerText = "Guardar Agenda";
        modal.style.display = 'flex';
    }

    function abrirEdicion(id) {
        let ev = eventosGlobales.find(e => String(e.id) === String(id));
        if(!ev) return;
        
        isEditing = true;
        editingEventId = id;
        
        document.getElementById('modalTitle').innerText = "Editar Evento";
        document.getElementById('btnGuardarEvent').innerText = "Guardar Cambios";
        limpiarFormulario();

        document.getElementById('eventTitle').value = ev.titulo;
        document.getElementById('eventType').value = ev.categoria;
        manejarCambioCategoria(); 
        document.getElementById('eventDate').value = ev.fecha.split("T")[0];
        document.getElementById('eventTimeRaw').value = parseTimeTo24h(ev.hora);
        
        let notaVal = "";
        let refBase = ev.referencia || "";
        if(refBase.includes(" / Nota: ")) {
            let partes = refBase.split(" / Nota: ");
            refBase = partes[0];
            notaVal = partes[1].split(" | REC-")[0];
        }
        document.getElementById('eventNota').value = notaVal;
        
        if(ev.cliente && ev.cliente !== 'Sin asignar') {
            document.getElementById('usarClienteCheckbox').checked = true;
            toggleCliente();
            document.getElementById('clienteBusqueda').value = ev.cliente;
            document.getElementById('eventReferencia').innerHTML = `<option value="${refBase}">${refBase}</option>`;
        }
        
        modal.style.display = 'flex';
    }
    
    function closeModal() { modal.style.display = 'none'; }

    function limpiarFormulario() {
        document.getElementById('eventType').selectedIndex = 0;
        document.getElementById('eventTitle').value = "";
        document.getElementById('eventTimeRaw').value = "";
        document.getElementById('eventNota').value = "";
        document.getElementById('clienteBusqueda').value = "";
        document.getElementById('clienteSeleccionadoId').value = "";
        document.getElementById('usarClienteCheckbox').checked = false;
        document.getElementById('mensualCheckbox').checked = false;
        document.getElementById('seccionCliente').style.display = 'none';
        document.getElementById('recurrenteContainer').style.display = 'none';
        const ref = document.getElementById('eventReferencia');
        if (ref) ref.innerHTML = '<option value="">Cargando referencias...</option>';
        document.getElementById("eventNota").placeholder = "Ej: Detalles adicionales...";
    }

    async function guardarEvento() {
        const titulo = document.getElementById('eventTitle').value.trim();
        const categoria = document.getElementById('eventType').value;
        const timeRaw = document.getElementById('eventTimeRaw').value; 
        const hora = formatTimeForSave(timeRaw); 
        const cliente = document.getElementById('clienteBusqueda').value;
        const nota = document.getElementById('eventNota').value.trim();
        
        const fechaSeleccionada = document.getElementById('eventDate').value;
        const referencia = document.getElementById('eventReferencia') ? document.getElementById('eventReferencia').value : "N/A";
        let referenciaFinal = referencia;
        const esMensual = document.getElementById('mensualCheckbox').checked;

        if (!fechaSeleccionada) return alert("Por favor selecciona una fecha");
        if (!titulo || !timeRaw) return alert("Por favor completa el t√≠tulo y la hora");

        if (referencia && referencia !== "N/A" && referencia !== "VENTA DIRECTA" && !referencia.includes("OP-") && !referencia.includes("COT-")) {
            if (categoria === "Instalaciones") referenciaFinal = "OP-" + referencia;
            if (categoria === "Visitas t√©cnicas") referenciaFinal = "COT-" + referencia;
        }

        const btn = document.getElementById('btnGuardarEvent');
        btn.innerText = "Procesando...";
        btn.disabled = true;

        const baseRef = referenciaFinal || "N/A";
        let refLimpia = baseRef.split(" | REC-")[0]; 

        // Si es Edici√≥n, borramos el anterior silenciosamente.
        if(isEditing && editingEventId) {
            try {
                await fetch(WEBAPP_URL, { method: "POST", body: JSON.stringify({ tipo: "eliminar_evento", id: editingEventId }) });
                eventosGlobales = eventosGlobales.filter(e => String(e.id) !== String(editingEventId));
            } catch(e) {}
        }

        const groupId = esMensual ? "REC-" + Date.now() : "";
        const iteraciones = esMensual && !isEditing ? 12 : 1; 
        const [anio, mes, dia] = fechaSeleccionada.split("-");
        const fechaBase = new Date(parseInt(anio), parseInt(mes) - 1, parseInt(dia));

        try {
            for (let i = 0; i < iteraciones; i++) {
                const fechaIteracionObj = new Date(fechaBase.getFullYear(), fechaBase.getMonth() + i, fechaBase.getDate());
                const y = fechaIteracionObj.getFullYear();
                const m = String(fechaIteracionObj.getMonth() + 1).padStart(2, '0');
                const d = String(fechaIteracionObj.getDate()).padStart(2, '0');
                const fechaIteracionStr = `${y}-${m}-${d}`;

                // Empacar la Nota
                let refGuardar = refLimpia;
                if (nota) refGuardar += ` / Nota: ${nota}`;
                if (esMensual && !isEditing) refGuardar += ` | ${groupId}`;

                const datos = {
                    tipo: "nuevo_evento",
                    fecha: fechaIteracionStr, hora: hora, titulo: titulo, categoria: categoria,
                    cliente: cliente || "Sin asignar", referencia: refGuardar
                };

                const response = await fetch(WEBAPP_URL, { method: "POST", body: JSON.stringify(datos) });
                const data = await response.json();

                if (data.status === "success") {
                    eventosGlobales.push({
                        id: data.id || Date.now() + i,
                        fecha: fechaIteracionStr, hora: hora, titulo: titulo, categoria: categoria,
                        cliente: cliente || "Sin asignar", referencia: refGuardar, estado: "PENDIENTE"
                    });
                }
            } 

            localStorage.setItem("CACHE_EVENTOS", JSON.stringify(eventosGlobales));
            closeModal();
            procesarEventosLocales();

        } catch (error) {
            alert("Hubo un problema al conectar con el servidor");
        } finally {
            btn.disabled = false;
        }
    }

    // ==========================================
    // BORRADO Y DESHACER (CTRL+Z M√ÅGICO)
    // ==========================================
    function inicializarEventosSwipe() {
        const wrappers = document.querySelectorAll('.evento-swipe-wrapper');
        wrappers.forEach(wrapper => {
            const content = wrapper.querySelector('.evento-card-content');
            if (wrapper.dataset.swipeActivo) return;
            wrapper.dataset.swipeActivo = "true";

            let startX = 0; let currentX = 0; let isDragging = false;

            content.addEventListener("touchstart", (e) => {
                startX = e.touches[0].clientX; currentX = startX; isDragging = true; content.style.transition = "none";
            }, {passive: true});

            content.addEventListener("touchmove", (e) => {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                if (diff < 0) {
                    content.style.transform = `translateX(${diff > -120 ? diff : -(120 + Math.abs(diff + 120) * 0.2)}px)`;
                }
            }, {passive: true});

            content.addEventListener("touchend", () => {
                if (!isDragging) return;
                isDragging = false;
                content.style.transition = "transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)";
                if ((currentX - startX) < -120) { // Mayor sensibilidad
                    content.style.transform = "translateX(-120%)";
                    setTimeout(() => { eliminarEventoVisual(wrapper, wrapper.id.split('-').pop()); }, 300);
                } else {
                    content.style.transform = "translateX(0)";
                }
            });
        });
    }

    function eliminarEventoVisual(elemento, eventId) {
        const ev = eventosGlobales.find(e => String(e.id) === String(eventId));
        if(ev) ultimoEventoBorrado = {...ev}; 

        elemento.style.transition = "all 0.3s ease"; elemento.style.opacity = "0"; elemento.style.height = "0px"; elemento.style.marginBottom = "0px";
        
        setTimeout(() => {
            elemento.remove();
            eventosGlobales = eventosGlobales.filter(e => String(e.id) !== String(eventId));
            localStorage.setItem("CACHE_EVENTOS", JSON.stringify(eventosGlobales));
            fetch(WEBAPP_URL, { method: "POST", body: JSON.stringify({ tipo: "eliminar_evento", id: eventId }) });
            
            actualizarContadorVencidas(); 
            procesarEventosLocales(); 

            // Activar bot√≥n deshacer
            if(ultimoEventoBorrado) {
                const btnUndo = document.getElementById("undoContainer");
                btnUndo.style.display = "flex";
                clearTimeout(undoTimeout);
                undoTimeout = setTimeout(() => {
                    btnUndo.style.display = "none";
                    ultimoEventoBorrado = null;
                }, 15000); // 15 segundos para arrepentirse
            }
        }, 300);
    }

    async function deshacerBorrado() {
        if (!ultimoEventoBorrado) return;
        
        const btnUndo = document.getElementById("undoContainer");
        btnUndo.style.display = "none";
        clearTimeout(undoTimeout);

        eventosGlobales.push(ultimoEventoBorrado);
        localStorage.setItem("CACHE_EVENTOS", JSON.stringify(eventosGlobales));

        try {
            await fetch(WEBAPP_URL, {
                method: "POST",
                body: JSON.stringify({ tipo: "restaurar_evento", ...ultimoEventoBorrado })
            });
        } catch(e) {}

        ultimoEventoBorrado = null;
        procesarEventosLocales(); 
    }

    // ==========================================
    // BUSCADOR CLIENTES M√ìDULO NUEVO EVENTO
    // ==========================================
    let timeoutBusqueda;
    async function buscarClienteApp(valor) {
        if (valor.length < 3) {
            document.getElementById('listaSugerencias').style.display = 'none';
            return;
        }

        const texto = valor.toLowerCase().trim();
        const lista = document.getElementById('listaSugerencias');
        lista.innerHTML = "";
        
        const cacheClientes = localStorage.getItem("CACHE_CLIENTES");
        if (cacheClientes) {
            try {
                const clientesObj = JSON.parse(cacheClientes);
                const clientesArr = Object.values(clientesObj);
                const resultadosLocales = clientesArr.filter(c => 
                    (c.nombre && c.nombre.toLowerCase().includes(texto)) || 
                    (c.cedula && String(c.cedula).includes(texto))
                ).slice(0, 8);

                if (resultadosLocales.length > 0) {
                    lista.style.display = 'block';
                    resultadosLocales.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'sugerencia-item';
                        div.innerHTML = `<strong>${c.nombre}</strong> <br> <small>${c.cedula}</small>`;
                        div.onclick = () => seleccionarCliente(c.nombre, c.cedula);
                        lista.appendChild(div);
                    });
                    return; 
                }
            } catch(e) {}
        }

        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(async () => {
            try {
                const res = await fetch(`${WEBAPP_URL}?buscarCliente=${encodeURIComponent(valor)}`);
                const data = await res.json();
                if (data.status === "ok" && data.resultados.length > 0) {
                    lista.style.display = 'block';
                    data.resultados.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'sugerencia-item';
                        div.innerHTML = `<strong>${c.nombre}</strong> <br> <small>${c.cedula}</small>`;
                        div.onclick = () => seleccionarCliente(c.nombre, c.cedula);
                        lista.appendChild(div);
                    });
                }
            } catch (e) {}
        }, 300);
    }

    async function seleccionarCliente(nombre, cedula) {
        document.getElementById('clienteBusqueda').value = nombre;
        document.getElementById('clienteSeleccionadoId').value = cedula;
        document.getElementById('listaSugerencias').style.display = 'none';
        
        const seccionRef = document.getElementById('seccionReferencia');
        const selectRef = document.getElementById('eventReferencia');
        const categoriaSeleccionada = document.getElementById('eventType').value;

        seccionRef.style.display = 'block';
        selectRef.innerHTML = '<option value="">Cargando referencias...</option>';

        const cacheOrdenesStr = localStorage.getItem("CACHE_ORDENES");
        if (cacheOrdenesStr) {
            try {
                const ordenes = JSON.parse(cacheOrdenesStr);
                const previas = ordenes.filter(o => String(o.cedula) === String(cedula));
                
                selectRef.innerHTML = '<option value="VENTA DIRECTA">Sin referencia (Venta directa)</option>';
                if (previas.length > 0) {
                    previas.forEach(ref => { selectRef.innerHTML += `<option value="${ref.numero}">OP-${ref.numero} | Saldo: $${ref.saldo}</option>`; });
                } else { selectRef.innerHTML += '<option value="N/A">Sin registros previos</option>'; }
                cargarReferenciasRedSilenciosa(cedula, categoriaSeleccionada, selectRef);
                return; 
            } catch(e) {}
        }
        await cargarReferenciasRedSilenciosa(cedula, categoriaSeleccionada, selectRef);
    }

    async function cargarReferenciasRedSilenciosa(cedula, categoriaSeleccionada, selectElement) {
        try {
            const res = await fetch(`${WEBAPP_URL}?tipo=BUSCAR_REFERENCIAS&cedula=${cedula}&categoria=${encodeURIComponent(categoriaSeleccionada)}`);
            const data = await res.json();
            selectElement.innerHTML = '<option value="VENTA DIRECTA">Sin referencia (Venta directa)</option>';
            if (data.status === "ok" && data.referencias && data.referencias.length > 0) {
                data.referencias.forEach(ref => { selectElement.innerHTML += `<option value="${ref.id}">${ref.detalle}</option>`; });
            } else { selectElement.innerHTML += '<option value="N/A">Sin registros previos</option>'; }
        } catch (e) {}
    }

    inicializarCalendario(); 

    function manejarCambioCategoria() {
        const categoria = document.getElementById("eventType").value;
        const contenedorCliente = document.getElementById("usarClienteContainer");
        const contenedorRecurrente = document.getElementById("recurrenteContainer");
        const notaInput = document.getElementById("eventNota");

        // Cambiar Placeholder Din√°micamente
        if (categoria === "Instalaciones") {
            notaInput.placeholder = "Ej: Llamar al piaggio antes, confirmar con la cliente...";
        } else if (categoria === "Visitas t√©cnicas") {
            notaInput.placeholder = "Ej: No olvidar el metro, llevar cat√°logo de sheer...";
        } else if (categoria === "Recordatorios de pago") {
            notaInput.placeholder = "Ej: N√∫mero de referencia de pago, contrato, llevar efectivo...";
        } else if (categoria === "Obligaciones tributarias") {
            notaInput.placeholder = "Ej: Formulario N¬∞ de la DIAN...";
        } else if (categoria === "Garant√≠as") {
            notaInput.placeholder = "Ej: Llevar nuevos herrajes, llevar cord√≥n...";
        } else {
            notaInput.placeholder = "Ej: Detalles adicionales...";
        }

        if (categoria === "Instalaciones" || categoria === "Visitas t√©cnicas") {
            contenedorCliente.style.display = "block";
        } else {
            contenedorCliente.style.display = "none";
            document.getElementById("usarClienteCheckbox").checked = false;
            document.getElementById("seccionCliente").style.display = "none";
        }

        if (categoria === "Recordatorios de pago" || categoria === "Obligaciones tributarias") {
            contenedorRecurrente.style.display = "block";
        } else {
            contenedorRecurrente.style.display = "none";
            document.getElementById("mensualCheckbox").checked = false;
        }
    }

    function toggleCliente() {
        const usar = document.getElementById("usarClienteCheckbox").checked;
        document.getElementById("seccionCliente").style.display = usar ? "block" : "none";
    }
</script>
</body>
</html>
