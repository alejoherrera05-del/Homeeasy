<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HomeEasy | Orden de Pedido</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- VARIABLES PREMIUM --- */
        :root { 
            --homeeasy-wine: #a6455a;  
            --homeeasy-gold: #c2a468;  
            --app-bg: #f8f9fa;
        }
        
        body { 
            background-color: var(--app-bg); 
            font-family: 'Montserrat', sans-serif; 
            color: #333; 
            margin: 0; 
            padding: 20px 10px;
        }
        
        .text-uppercase-input { text-transform: uppercase; }
        
        /* Bot√≥n Volver */
        .btn-back { 
            position: fixed; 
            top: calc(15px + env(safe-area-inset-top)); 
            left: 15px; 
            z-index: 1000; 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(5px);
            border-radius: 50%; 
            width: 45px; 
            height: 45px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            color: var(--homeeasy-wine); 
            text-decoration: none; 
            font-size: 1.2rem; 
            transition: transform 0.2s;
        }
        .btn-back:active { transform: scale(0.9); }
        
        /* Contenedor Principal PDF */
        #area-pdf { 
            background-color: white; 
            width: 100%; 
            max-width: 800px; 
            margin: 0 auto; 
            min-height: 1035px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.05); 
            border-radius: 12px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }
        
        /* Cabecera Documento */
        .header-brand { 
            background-color: var(--homeeasy-wine); 
            padding: 25px 35px 40px 35px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            position: relative; 
        }
        .logo-only { max-width: 130px; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        .empresa-info-header { font-size: 0.75rem; color: #ffffff; text-align: right; line-height: 1.5; font-weight: 500;}
        .empresa-info-header b { color: var(--homeeasy-gold); font-size: 0.85rem; font-weight: 800; letter-spacing: 0.5px;}
        .empresa-info-header i { color: var(--homeeasy-gold); width: 18px; text-align: center; margin-right: 4px; }

        /* Etiqueta N¬∞ Orden */
        .order-meta { 
            position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); 
            background: white; padding: 10px 25px; border-radius: 30px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; 
            display: flex; gap: 20px; z-index: 10; white-space: nowrap; 
        }
        .meta-item { font-size: 0.7rem; font-weight: 800; color: var(--homeeasy-wine); text-transform: uppercase; letter-spacing: 0.5px;}

        /* T√≠tulo del Documento */
        .document-type { 
            background-color: #ffffff; color: var(--homeeasy-wine); text-align: center; 
            padding: 40px 12px 20px 12px; font-weight: 300; text-transform: uppercase; 
            letter-spacing: 8px; border-bottom: 1px solid rgba(166, 69, 90, 0.1); font-size: 1.6rem;
        }
        
        .card-body { padding: 30px 35px; flex-grow: 1; display: flex; flex-direction: column;}

        .section-title { 
            font-weight: 800; text-transform: uppercase; font-size: 0.8rem; 
            color: var(--homeeasy-wine); border-bottom: 2px solid #f0f0f0; 
            padding-bottom: 5px; margin-bottom: 15px; display: block; letter-spacing: 1px;
        }
        
        .form-label-small { font-size: 0.65rem; font-weight: 700; color: #aaa; text-transform: uppercase; margin-bottom: 2px; }
        .form-control-compact { 
            border: none; border-bottom: 1px solid #e0e0e0; border-radius: 0; 
            padding: 5px 0; font-size: 0.9rem; font-weight: 600; background: transparent; 
            width: 100%; transition: all 0.3s; color: #333;
        }
        .form-control-compact:focus { outline: none; border-bottom-color: var(--homeeasy-gold); box-shadow: none; }
        .form-control-compact::placeholder { color: #ccc; font-weight: 400; }

        /* Tabla */
        .table { margin-bottom: 5px; }
        .table th { 
            font-size: 0.7rem; text-transform: uppercase; font-weight: 800; color: #555; 
            border-bottom: 2px solid var(--homeeasy-wine) !important; padding: 10px 5px; 
        }
        .table td { padding: 8px 5px; border-bottom: 1px solid #f5f5f5; vertical-align: middle;}
        
        /* Caja Finanzas */
        .finance-box { 
            background-color: #fafafa; border-radius: 12px; padding: 20px; 
            border-left: 6px solid var(--homeeasy-gold); height: 100%;
        }
        
        /* Bot√≥n Guardar */
        .btn-homeeasy { 
            background-color: var(--homeeasy-wine); color: white; border: none; 
            font-weight: 800; padding: 18px; width: 100%; text-transform: uppercase; 
            border-radius: 12px; margin-top: 30px; font-size: 1rem; letter-spacing: 1px;
            box-shadow: 0 8px 20px rgba(166, 69, 90, 0.3); transition: transform 0.2s;
        }
        .btn-homeeasy:active { transform: scale(0.98); }
        
        /* Footer */
        .pdf-footer { 
            background-color: #fafafa; padding: 20px; text-align: center; 
            border-top: 1px solid #eee; margin-top: auto; 
        }
        .footer-logo { max-width: 80px; opacity: 0.4; margin-bottom: 10px; filter: grayscale(100%); }
        .footer-creds { font-size: 0.65rem; color: #777; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; }

        /* üì± RESPONSIVE M√ìVIL */
        @media (max-width: 768px) {
            body { padding: 0; background-color: white; }
            #area-pdf { box-shadow: none; border-radius: 0; min-height: 100vh; margin: 0; }
            .header-brand { padding: calc(25px + env(safe-area-inset-top)) 20px 35px 20px; }
            .logo-only { max-width: 100px; }
            .empresa-info-header { font-size: 0.65rem; }
            .empresa-info-header b { font-size: 0.75rem; }
            .order-meta { width: 85%; padding: 8px 15px; bottom: -20px; font-size: 0.65rem; justify-content: center; }
            .document-type { padding: 45px 15px 15px 15px; font-size: 1.3rem; letter-spacing: 4px; }
            .card-body { padding: 25px 15px; }
            .finance-box { padding: 15px; }
            .table th { font-size: 0.65rem; }
            .table td { font-size: 0.8rem; }
        }

        /* üñ®Ô∏è PDF EXPORT MODE (Congela para PDF) */
        .pdf-export-mode .header-brand { padding: 15px 30px 25px 30px !important; flex-direction: row !important; text-align: right !important; }
        .pdf-export-mode .empresa-info-header { font-size: 0.75rem !important; }
        .pdf-export-mode .logo-only { max-width: 130px !important; }
        .pdf-export-mode .order-meta { width: auto !important; padding: 10px 25px !important; bottom: -18px !important; font-size: 0.7rem !important; }
        .pdf-export-mode .document-type { padding: 35px 12px 10px 12px !important; font-size: 1.4rem !important; letter-spacing: 8px !important; }
        .pdf-export-mode .card-body { padding: 15px 30px !important; }
        .pdf-export-mode .finance-box { padding: 10px 20px !important; }
        .pdf-export-mode .section-title { margin-bottom: 5px !important; }
        .pdf-export-mode .row.g-4 { row-gap: 0.5rem !important; }
        .pdf-export-mode .mb-5 { margin-bottom: 0.8rem !important; }
        .pdf-export-mode .mb-4 { margin-bottom: 0.5rem !important; }
        .pdf-export-mode .table th, .pdf-export-mode .table td { padding: 6px 5px !important; font-size: 0.8rem !important;}
        .pdf-export-mode .pdf-footer { padding: 10px !important; }

        /* PANTALLAS DE CARGA Y √âXITO */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 9999; justify-content: center; align-items: center; }
        .glass-loader { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 25px; padding: 35px 30px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); text-align: center; width: 85%; max-width: 340px; }
        .hommy-loader { width: 140px; height: auto; margin-bottom: 15px; }
        .step-item { font-size: 0.85rem; color: #777; font-weight: 600; opacity: 0.4; transition: all 0.3s; margin-bottom: 10px; display: flex; align-items: center; justify-content: start; gap: 10px; text-align: left; }
        .step-active { opacity: 1; color: var(--homeeasy-wine); font-weight: 800; }
        .step-check { opacity: 1; color: #2ecc71; font-weight: 700; }

        .success-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); z-index: 10000; justify-content: center; align-items: center; }
        .success-box { background: white; border-radius: 28px; padding: 40px 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); text-align: center; width: 85%; max-width: 340px; border: 1px solid rgba(194, 164, 104, 0.3); animation: popIn 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .success-icon { width: 80px; height: 80px; background: rgba(46, 204, 113, 0.15); color: #27ae60; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 40px; margin: 0 auto 20px; }
        .success-box h3 { color: var(--homeeasy-wine); font-weight: 800; font-size: 1.5rem; margin-bottom: 10px; letter-spacing: -0.5px;}
        .success-box p { color: #666; font-size: 0.9rem; margin-bottom: 30px; line-height: 1.5; font-weight: 500;}
        .btn-success-home { background: var(--homeeasy-wine); color: white; border: none; font-weight: 800; padding: 16px; width: 100%; border-radius: 14px; font-size: 1rem; transition: transform 0.2s; box-shadow: 0 8px 20px rgba(166, 69, 90, 0.25);}
        .btn-success-home:active { transform: scale(0.95); }

        .row-desc, #notas { height: auto !important; min-height: 35px; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body ontouchstart="">

<div id="loading" class="loading-overlay">
    <div class="glass-loader">
        <img src="Hommycompleto.png" class="hommy-loader" alt="Hommy" onerror="this.src='HOMMY.png'">
        <h6 style="color:var(--homeeasy-wine); font-weight: 800; letter-spacing: 1px; margin-bottom: 5px;" id="lbl-proceso">PROCESANDO...</h6>
        <p class="small text-muted mb-4">Hommy est√° generando tu orden</p>
        
        <div id="status-list" style="text-align: left; margin-left: 10px;">
            <div id="step-1" class="step-item"><i class="far fa-circle"></i> Revisando las medidas...</div>
            <div id="step-2" class="step-item"><i class="far fa-circle"></i> Imprimiendo OP...</div>
            <div id="step-3" class="step-item"><i class="far fa-circle"></i> Programando fabricaci√≥n...</div>
            <div id="step-4" class="step-item"><i class="far fa-circle"></i> ¬°Orden sellada y lista!</div>
        </div>
    </div>
</div>

<div id="success-modal" class="success-overlay">
    <div class="success-box">
        <div class="success-icon"><i class="fas fa-check"></i></div>
        <h3>¬°Orden Confirmada!</h3>
        <p id="exito-msg">La orden fue creada, sincronizada y est√° lista para enviarse al cliente.</p>
        <button id="btn-success-home" class="btn-success-home" onclick="window.location.replace('index.html')">Volver al Men√∫</button>
    </div>
</div>

<a id="btn-back" href="index.html" class="btn-back no-print"><i class="fas fa-arrow-left"></i></a>

<div id="area-pdf">
    <div class="header-brand">
        <img src="logohomeeasy.png" class="logo-only" alt="HomeEasy" onerror="this.src='triangulogold.png'; this.style.width='60px'">
        <div class="empresa-info-header">
            <b>HOMEEASY POPAY√ÅN</b><br>
            <span>NIT: 1.061.760.850-1</span><br>
            <span><i class="fas fa-map-marker-alt"></i> Trav. 9 # 6N-26</span><br>
            <span><i class="fas fa-phone-alt"></i> 3334319374</span><br>
            <span><i class="fab fa-instagram"></i> @homeeasypopayan</span>
        </div>
        <div class="order-meta">
            <div class="meta-item">ORDEN N¬∞: <span id="n_orden_display" style="color: #333;">...</span></div>
            <div class="meta-item">Fecha: <span id="fecha_display" style="color: #333;"></span></div>
        </div>
    </div>
    
    <div class="document-type">ORDEN DE PEDIDO</div>
    
    <div class="card-body">
        
        <span class="section-title">Informaci√≥n del Cliente</span>
        <div class="row g-3 mb-4">
            <div class="col-md-4 col-12">
                <label class="form-label-small">C√©dula / NIT</label>
                <input type="text" id="cedula" class="form-control-compact" placeholder="Buscar por c√©dula o nombre..." autocomplete="off">
                <div id="sugerencias_cliente" style="background:white; border-radius:10px; max-height:200px; overflow:auto; box-shadow:0 10px 20px rgba(0,0,0,0.15); margin-top:5px; display:none; position: absolute; z-index: 100; width: 90%;"></div>
            </div>
            <div class="col-md-8 col-12">
                <label class="form-label-small">Nombre Completo</label>
                <input type="text" id="nombre" class="form-control-compact text-uppercase-input" oninput="capFirst(this)">
            </div>
            <div class="col-md-4 col-12">
                <label class="form-label-small">Tel√©fono</label>
                <input type="tel" id="telefono" inputmode="numeric" class="form-control-compact">
            </div>
            <div class="col-md-8 col-12">
                <label class="form-label-small">Correo Electr√≥nico</label>
                <input type="email" id="email" class="form-control-compact" style="text-transform: lowercase;">
            </div>
            <div class="col-12">
                <label class="form-label-small">Direcci√≥n de Instalaci√≥n</label>
                <input type="text" id="direccion" class="form-control-compact text-uppercase-input" oninput="capFirst(this)">
            </div>
        </div>

        <span class="section-title mt-2">Detalle de Fabricaci√≥n</span>
        <div class="table-responsive" style="overflow-x: visible;">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>Descripci√≥n del Art√≠culo</th>
                        <th width="70" class="text-center">Cant.</th>
                        <th width="130" class="text-center">V. Unitario</th>
                        <th width="130" class="text-end">V. Total</th>
                        <th width="30" class="no-print"></th>
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    <tr>
                        <td><input type="text" class="form-control-compact row-desc" placeholder="Ej: Sheer Elegance Blanca" oninput="capFirst(this)"></td>
                        <td><input type="number" class="form-control-compact text-center cant" value="1" inputmode="numeric" oninput="calcular()"></td>
                        <td><input type="text" class="form-control-compact text-center precio" placeholder="$ 0" inputmode="numeric" oninput="formatear(this); calcular()"></td>
                        <td class="item-total fw-bold text-end" style="color: var(--homeeasy-wine);">$ 0</td>
                        <td class="no-print text-end"><button class="btn btn-sm" style="color:#e74c3c; padding:0;" onclick="eliminarFila(this)"><i class="fas fa-times"></i></button></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button class="btn btn-sm no-print mb-4" style="background: rgba(194, 164, 104, 0.15); color: var(--homeeasy-gold); font-weight: 700; border-radius: 8px;" onclick="agregarFila()">+ A√±adir L√≠nea</button>

        <div class="mb-4">
            <label class="form-label-small">Observaciones de Fabricaci√≥n</label>
            <textarea id="notas" class="form-control-compact" style="height: 40px; resize: none;" placeholder="Ej: Medidas exactas, lado del mando, accesorios..." oninput="capFirst(this)"></textarea>
        </div>

        <div class="row g-4 mt-auto">
            <div class="col-md-6 col-12 d-flex flex-column justify-content-end">
                <span class="section-title mb-2">Condiciones de Venta</span>
                <div style="font-size: 0.75rem; color: #666; line-height: 1.6;">
                    ‚Ä¢ <b>Garant√≠a:</b> 3 a√±os (aplica t√©rminos y condiciones).<br>
                    ‚Ä¢ <b>Tiempo de entrega:</b> 10 d√≠as h√°biles.<br>
                    ‚Ä¢ <b>Saldo:</b> Se cancela contra entrega e instalaci√≥n.<br>
                    ‚Ä¢ <b>Instalaci√≥n:</b> Incluida en el valor total pactado.
                </div>
            </div>
            
            <div class="col-md-6 col-12">
                <div class="finance-box">
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span style="font-size: 0.8rem; font-weight: 800; color: #888;">SUBTOTAL:</span>
                        <span id="subtotal_val" style="font-weight: 700; color: #555;">$ 0</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2" id="desc_row">
                        <span style="font-size: 0.8rem; font-weight: 800; color: var(--homeeasy-gold);">DESCUENTO:</span>
                        <input type="text" id="descuento_input" class="form-control-compact text-end p-0" style="width: 100px; font-weight: 800; color: #e74c3c; border-bottom: 1px dashed #e74c3c;" placeholder="-$ 0" inputmode="numeric" oninput="formatear(this); calcular()">
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span style="font-size: 0.8rem; font-weight: 800; color: #333;">TOTAL PEDIDO:</span>
                        <span id="total_pedido_val" style="font-weight: 800; color: #333;">$ 0</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2 mt-3">
                        <span style="font-size: 0.8rem; font-weight: 800; color: var(--homeeasy-gold);">ABONO INICIAL:</span>
                        <input type="text" id="abono" class="form-control-compact text-end p-0" style="width: 120px; font-weight: 800; color: var(--homeeasy-wine); border-bottom: 2px solid var(--homeeasy-wine);" placeholder="$ 0" inputmode="numeric" oninput="formatear(this); calcular()">
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-3" style="border-top: 2px solid #eaeaea;">
                        <span style="font-size: 1.1rem; font-weight: 800; color: var(--homeeasy-wine);">SALDO:</span>
                        <span id="saldo_pendiente_val" style="font-size: 1.4rem; font-weight: 800; color: var(--homeeasy-wine);">$ 0</span>
                    </div>
                </div>
            </div>
        </div>

        <button class="btn btn-homeeasy no-print" id="btnProcesar" onclick="finalizar()"><i class="fas fa-cloud-upload-alt me-2"></i> Generar Orden de Pedido</button>
    </div>

    <div class="pdf-footer">
        <img src="Hommypiedepagina.png" alt="Hommy" style="height: 35px; opacity: 0.5; margin-bottom: 8px;">
        <div class="footer-creds">HomeEasy - Viste tu hogar con estilo</div>
        <div style="font-size: 0.6rem; color: #aaa; margin-top: 5px;">Documento oficial generado por Sistema Hommy V2.0</div>
    </div>
</div>

<script>
    const URL_G = "https://script.google.com/macros/s/AKfycbyZHaIe7hb28KKtaPBORASy_maSZ2co8dZFce44GQRiZGYg_6WoU7qn4qC-lYCQO6ZL/exec";
    
    let numeroCot = null;
    let isEditMode = false;
    let editNum = null;
    let returnCedula = null; 

    // ==========================================
    // 1. CARGA INICIAL Y MODO EDICI√ìN
    // ==========================================
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        editNum = params.get("edit");
        numeroCot = params.get("cotizacion");
        returnCedula = params.get("return_cedula"); 

        if (returnCedula) {
            document.getElementById("btn-back").href = `clientes.html?search=${returnCedula}`;
        }

        if (editNum) {
            isEditMode = true;
            document.getElementById("n_orden_display").innerText = editNum;
            document.getElementById("btnProcesar").innerHTML = '<i class="fas fa-save me-2"></i> Guardar Cambios';
            
            // Cargar OP existente
            fetch(`${URL_G}?tipo=EDITAR_OP&numero=${editNum}`)
            .then(r => r.json())
            .then(d => {
                if(d.status === "found") {
                    document.getElementById('fecha_display').innerText = new Date(d.fecha).toLocaleDateString('es-CO');
                    document.getElementById('cedula').value = d.cedula;
                    document.getElementById('nombre').value = d.nombre;
                    document.getElementById('notas').value = d.observaciones || ""; 
                    document.getElementById('abono').value = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(d.abono || 0);
                    
                    buscarCliente(); 
                    
                    let items = [];
                    
                    try { 
                        if(d.itemsJSON && d.itemsJSON !== "[]" && d.itemsJSON !== "") {
                            let parsed = JSON.parse(d.itemsJSON);
                            if(typeof parsed === 'string') parsed = JSON.parse(parsed); 
                            if(Array.isArray(parsed)) items = parsed;
                        }
                    } catch(e) { console.warn("JSON error"); }

                    if(items.length === 0 && d.descripcion && d.descripcion.includes(" x ")) {
                        let partes = d.descripcion.split('/');
                        partes.forEach(p => {
                            let txt = p.trim();
                            if(txt) {
                                let div = txt.split(' x ');
                                if(div.length === 2) {
                                    items.push({ cantidad: parseFloat(div[0]) || 1, descripcion: div[1].trim(), precio: 0 });
                                } else {
                                    items.push({ cantidad: 1, descripcion: txt, precio: 0 });
                                }
                            }
                        });
                    }

                    let subtotalCarga = 0;

                    if(items.length > 0) {
                        const tbody = document.getElementById("tabla-body");
                        tbody.innerHTML = ""; 
                        
                        items.forEach(item => {
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td><input type="text" class="form-control-compact row-desc" oninput="capFirst(this)"></td>
                                <td><input type="number" class="form-control-compact text-center cant" value="1" inputmode="numeric" oninput="calcular()"></td>
                                <td><input type="text" class="form-control-compact text-center precio" inputmode="numeric" oninput="formatear(this); calcular()"></td>
                                <td class="item-total fw-bold text-end" style="color: var(--homeeasy-wine);">$ 0</td>
                                <td class="no-print text-end"><button class="btn btn-sm" style="color:#e74c3c; padding:0;" onclick="eliminarFila(this)"><i class="fas fa-times"></i></button></td>
                            `;
                            tbody.appendChild(tr);
                            
                            tr.querySelector(".row-desc").value = item.descripcion || "";
                            tr.querySelector(".cant").value = item.cantidad || 1;
                            
                            let pr = parseFloat(item.precio) || 0;
                            if (pr > 0) {
                                tr.querySelector(".precio").value = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(pr);
                            }
                            
                            subtotalCarga += (item.cantidad || 1) * pr;
                        });
                        
                        // üö® L√ìGICA DE DETECCI√ìN DE DESCUENTO EN OP
                        let totalGuardado = parseFloat(d.total) || 0;
                        if (totalGuardado > 0 && subtotalCarga > totalGuardado) {
                            let descuentoDetectado = subtotalCarga - totalGuardado;
                            document.getElementById('descuento_input').value = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(descuentoDetectado);
                        }

                        calcular();
                    }
                }
            });

        } else {
            // Flujo Normal: Crear Pedido Nuevo
            document.getElementById('fecha_display').innerText = new Date().toLocaleDateString('es-CO');
            fetch(`${URL_G}?nextPedido=1`)
                .then(r => r.json())
                .then(d => { if(d.status === "ok") document.getElementById("n_orden_display").innerText = d.nextPedido || "001"; })
                .catch(e => { document.getElementById("n_orden_display").innerText = "001"; });
        }

        fetch(`${URL_G}?init=LOAD`)
            .then(r => r.json())
            .then(data => {
                if (data.status === "ok" && data.clientes) {
                    const clientesObj = {};
                    for (let i = 1; i < data.clientes.length; i++) {
                        const c = data.clientes[i];
                        if(c && c[0]) { 
                            clientesObj[c[0]] = { cedula: c[0], nombre: c[1], telefono: c[2], email: c[3], direccion: c[4] }; 
                        }
                    }
                    localStorage.setItem("CACHE_CLIENTES", JSON.stringify(clientesObj));
                    if(!isEditMode && !numeroCot) buscarCliente(); 
                }
            }).catch(err => console.error("Error parchando cach√©:", err));

        // üö® MAGIA: CONVERTIR DE COTIZACI√ìN A OP (TRAYENDO DESCUENTOS Y NOTAS)
        if (numeroCot && !isEditMode) {
            fetch(`${URL_G}?convertirCot=${numeroCot}`)
                .then(r => r.json())
                .then(d => {
                    if (d.status === "found") {
                        document.getElementById("cedula").value = d.cedula;
                        document.getElementById("nombre").value = d.nombre.toUpperCase();
                        
                        document.getElementById("notas").value = d.observaciones || ""; 
                        
                        buscarCliente(); 

                        let items = [];
                        
                        try { 
                            if(d.itemsJSON && d.itemsJSON !== "[]" && d.itemsJSON !== "") {
                                let parsed = JSON.parse(d.itemsJSON);
                                if(typeof parsed === 'string') parsed = JSON.parse(parsed); 
                                if(Array.isArray(parsed)) items = parsed;
                            }
                        } catch(e) {}

                        if(items.length === 0 && d.descripcion && d.descripcion.includes(" x ")) {
                            let partes = d.descripcion.split('/');
                            partes.forEach(p => {
                                let txt = p.trim();
                                if(txt) {
                                    let div = txt.split(' x ');
                                    if(div.length === 2) {
                                        items.push({ cantidad: parseFloat(div[0]) || 1, descripcion: div[1].trim(), precio: 0 });
                                    } else {
                                        items.push({ cantidad: 1, descripcion: txt, precio: 0 });
                                    }
                                }
                            });
                        }

                        let subtotalCarga = 0;

                        if (items.length > 0) {
                            const tbody = document.getElementById("tabla-body");
                            tbody.innerHTML = "";
                            items.forEach(item => {
                                const tr = document.createElement("tr");
                                tr.innerHTML = `
                                    <td><input type="text" class="form-control-compact row-desc" oninput="capFirst(this)"></td>
                                    <td><input type="number" class="form-control-compact text-center cant" value="1" inputmode="numeric" oninput="calcular()"></td>
                                    <td><input type="text" class="form-control-compact text-center precio" inputmode="numeric" oninput="formatear(this); calcular()"></td>
                                    <td class="item-total fw-bold text-end" style="color: var(--homeeasy-wine);">$ 0</td>
                                    <td class="no-print text-end"><button class="btn btn-sm" style="color:#e74c3c; padding:0;" onclick="eliminarFila(this)"><i class="fas fa-times"></i></button></td>
                                `;
                                tbody.appendChild(tr);
                                tr.querySelector(".row-desc").value = item.descripcion || "";
                                tr.querySelector(".cant").value = item.cantidad || 1;
                                
                                let pr = parseFloat(item.precio) || 0;
                                if (pr > 0) { 
                                    tr.querySelector(".precio").value = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(pr); 
                                }
                                
                                subtotalCarga += (item.cantidad || 1) * pr;
                            });

                            // üö® L√ìGICA DE DETECCI√ìN DE DESCUENTO AL CONVERTIR COTIZACI√ìN
                            let totalGuardado = parseFloat(d.total) || 0;
                            if (totalGuardado > 0 && subtotalCarga > totalGuardado) {
                                let descuentoDetectado = subtotalCarga - totalGuardado;
                                document.getElementById('descuento_input').value = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(descuentoDetectado);
                            }

                            calcular();
                        }
                    }
                });
        }
    };

    // ==========================================
    // 2. MATEM√ÅTICAS FINANCIERAS (NUEVAS)
    // ==========================================
    function capFirst(input) { 
        let val = input.value; 
        if (val.length > 0) { 
            input.value = val.charAt(0).toUpperCase() + val.slice(1); 
        } 
    }

    function formatear(i) { 
        let v = i.value.replace(/\D/g, ""); 
        i.value = v ? new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v) : ""; 
    }

    function calcular() {
        let subtotal = 0;
        document.querySelectorAll('#tabla-body tr').forEach(tr => {
            let c = parseFloat(tr.querySelector('.cant').value) || 0; 
            let p = parseFloat(tr.querySelector('.precio').value.replace(/\D/g, "")) || 0; 
            let sub = c * p;
            tr.querySelector('.item-total').innerText = `$ ${sub.toLocaleString('es-CO')}`; 
            subtotal += sub;
        });
        
        // 1. Mostrar Subtotal
        document.getElementById('subtotal_val').innerText = `$ ${subtotal.toLocaleString('es-CO')}`;
        
        // 2. Descontar
        let descInput = document.getElementById('descuento_input').value; 
        let descuento = parseFloat(descInput.replace(/\D/g, "")) || 0;
        
        let totalFinal = subtotal - descuento; 
        if(totalFinal < 0) totalFinal = 0;
        
        // 3. Mostrar Total Real
        document.getElementById('total_pedido_val').innerText = `$ ${totalFinal.toLocaleString('es-CO')}`;
        
        // 4. Calcular Saldo post Abono
        let abono = parseFloat(document.getElementById('abono').value.replace(/\D/g, "")) || 0;
        let saldo = totalFinal - abono; 
        if(saldo < 0) saldo = 0;
        
        document.getElementById('saldo_pendiente_val').innerText = `$ ${saldo.toLocaleString('es-CO')}`;
    }

    function agregarFila() {
        let tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="form-control-compact row-desc" placeholder="Descripci√≥n..." oninput="capFirst(this)"></td>
            <td><input type="number" class="form-control-compact text-center cant" value="1" inputmode="numeric" oninput="calcular()"></td>
            <td><input type="text" class="form-control-compact text-center precio" placeholder="$ 0" inputmode="numeric" oninput="formatear(this); calcular()"></td>
            <td class="item-total fw-bold text-end" style="color: var(--homeeasy-wine);">$ 0</td>
            <td class="no-print text-end"><button class="btn btn-sm" style="color:#e74c3c; padding:0;" onclick="eliminarFila(this)"><i class="fas fa-times"></i></button></td>
        `;
        document.getElementById('tabla-body').appendChild(tr);
    }
    
    function eliminarFila(btn) { 
        btn.closest('tr').remove(); 
        calcular(); 
    }

    const loadingTexts = [ 
        "Acomodando el dise√±o final...", 
        "Imprimiendo PDF en 4K...", 
        "Programando la fabricaci√≥n...", 
        "¬°Orden sellada y lista!" 
    ];

    function setStep(num, status) {
        const step = document.getElementById('step-' + num);
        if (status === 'active') { 
            step.classList.add('step-active'); 
            step.classList.remove('step-check'); 
            step.innerHTML = `<i class="fas fa-circle-notch fa-spin text-warning"></i> ` + loadingTexts[num-1]; 
        } else if (status === 'check') { 
            step.classList.remove('step-active'); 
            step.classList.add('step-check'); 
            step.innerHTML = `<i class="fas fa-check-circle"></i> ` + loadingTexts[num-1]; 
        } else { 
            step.className = 'step-item'; 
            step.innerHTML = `<i class="far fa-circle"></i> ` + loadingTexts[num-1]; 
        }
    }

    // ============================================================
    // 3. üñ®Ô∏è MOTOR PDF FINAL Y GUARDADO EN LA NUBE
    // ============================================================
    async function finalizar() {
        const cedula = document.getElementById('cedula').value.trim();
        let nombre = document.getElementById('nombre').value.toUpperCase();
        let email = document.getElementById('email').value.toLowerCase();
        let numeroOP = document.getElementById("n_orden_display").innerText.trim() || "001";

        if (!cedula || !nombre) return alert("Por favor, ingresa al menos C√©dula y Nombre.");

        const loading = document.getElementById('loading');
        if(isEditMode) document.getElementById('lbl-proceso').innerText = "ACTUALIZANDO...";
        loading.style.display = 'flex';
        
        for(let i=1; i<=4; i++) { setStep(i, 'reset'); }

        try {
            setStep(1, 'active');
            
            const origBodyPadding = document.body.style.padding; 
            document.body.style.padding = '0';
            
            const areaPdf = document.getElementById('area-pdf'); 
            areaPdf.classList.add('pdf-export-mode');
            
            const origBorderRadius = areaPdf.style.borderRadius; 
            const origBoxShadow = areaPdf.style.boxShadow;
            areaPdf.style.borderRadius = '0px'; 
            areaPdf.style.boxShadow = 'none'; 
            areaPdf.style.width = '800px'; 
            areaPdf.style.maxWidth = '800px'; 
            areaPdf.style.margin = '0'; 

            await new Promise(r => setTimeout(r, 50));

            const canvas = await html2canvas(areaPdf, { 
                scale: 3, 
                useCORS: true, 
                width: 800, 
                windowWidth: 800, 
                x: areaPdf.offsetLeft, 
                y: areaPdf.offsetTop,
                onclone: function(clonedDoc) {
                    clonedDoc.querySelectorAll('.no-print').forEach(el => el.remove());
                    
                    clonedDoc.querySelectorAll('#tabla-body tr').forEach(f => { 
                        const desc = f.querySelector('.row-desc'); 
                        if(!desc || !desc.value.trim()) f.remove(); 
                    });
                    
                    const descInput = clonedDoc.getElementById('descuento_input'); 
                    const descRow = clonedDoc.getElementById('desc_row');
                    if (descInput && descRow) { 
                        const descVal = parseFloat(descInput.value.replace(/\D/g, "")); 
                        if (isNaN(descVal) || descVal === 0) { 
                            descRow.parentNode.removeChild(descRow); 
                        } else { 
                            descInput.style.border = 'none'; 
                        } 
                    }

                    const abonoInputClone = clonedDoc.getElementById('abono'); 
                    if (abonoInputClone) { 
                        abonoInputClone.style.borderBottom = 'none'; 
                        abonoInputClone.style.background = 'transparent'; 
                    }
                    
                    clonedDoc.querySelectorAll('.form-control-compact').forEach(input => { 
                        input.style.borderBottom = 'none'; 
                        input.style.background = 'transparent'; 
                        input.style.color = '#222'; 
                    });
                    
                    clonedDoc.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], input[type="number"]').forEach(input => {
                        const span = clonedDoc.createElement('span'); 
                        span.innerText = input.value; 
                        span.className = input.className; 
                        span.style.display = 'inline-block'; 
                        span.style.border = 'none'; 
                        span.style.background = 'transparent';
                        if(input.classList.contains('text-end')) span.style.textAlign = 'right'; 
                        if(input.classList.contains('text-center')) span.style.textAlign = 'center';
                        input.parentNode.replaceChild(span, input);
                    });
                    
                    clonedDoc.querySelectorAll('textarea').forEach(ta => {
                        const div = clonedDoc.createElement('div'); 
                        div.innerText = ta.value; 
                        div.className = ta.className; 
                        div.style.border = 'none'; 
                        div.style.background = 'transparent'; 
                        div.style.whiteSpace = 'pre-wrap';
                        ta.parentNode.replaceChild(div, ta);
                    });
                }
            });

            setStep(1, 'check'); 
            setStep(2, 'active');

            areaPdf.classList.remove('pdf-export-mode'); 
            document.body.style.padding = origBodyPadding; 
            areaPdf.style.borderRadius = origBorderRadius; 
            areaPdf.style.boxShadow = origBoxShadow; 
            areaPdf.style.width = '100%'; 
            areaPdf.style.margin = '0 auto';

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "mm", "letter"); 
            const pdfWidth = pdf.internal.pageSize.getWidth(); 
            const pdfHeight = pdf.internal.pageSize.getHeight(); 
            const canvasRatio = canvas.width / canvas.height;
            const finalWidth = pdfWidth; 
            let finalHeight = finalWidth / canvasRatio; 
            
            const imgData = canvas.toDataURL("image/jpeg", 1.0); 
            let heightLeft = finalHeight; 
            let position = 0;

            pdf.addImage(imgData, "JPEG", 0, position, finalWidth, finalHeight); 
            heightLeft -= pdfHeight;
            
            while (heightLeft > 0) { 
                position -= pdfHeight; 
                pdf.addPage(); 
                pdf.addImage(imgData, "JPEG", 0, position, finalWidth, finalHeight); 
                heightLeft -= pdfHeight; 
            }
            const pdfBase64 = pdf.output('datauristring').split(',')[1];

            // üö® CONSTRUCCI√ìN DE LAS VARIABLES PARA LA NUBE
            let descripcionTexto = ""; // √çtems (Col E)
            let itemsJSON = [];        // JSON
            
            document.querySelectorAll('#tabla-body tr').forEach(tr => {
                let descEl = tr.querySelector('.row-desc');
                let cantEl = tr.querySelector('.cant');
                let precioEl = tr.querySelector('.precio');
                
                if (descEl && cantEl && precioEl) {
                    let descripcion = descEl.value.trim(); 
                    let cantidad = parseFloat(cantEl.value) || 0; 
                    let precio = parseFloat(precioEl.value.replace(/\D/g, "")) || 0;
                    
                    if (descripcion) {
                        descripcionTexto += `${cantidad} x ${descripcion} / `;
                        itemsJSON.push({ 
                            descripcion: descripcion, 
                            cantidad: cantidad, 
                            precio: precio, 
                            subtotal: cantidad * precio 
                        });
                    }
                }
            });

            const totalFinal = parseFloat(document.getElementById('total_pedido_val').innerText.replace(/\D/g, "")) || 0;
            const abonoInicial = parseFloat(document.getElementById('abono').value.replace(/\D/g, "")) || 0;
            const notas = document.getElementById('notas').value; // Notas (Col F)
            const nombreArchivo = `Orden_N_${numeroOP}_${cedula}.pdf`;

            setStep(2, 'check'); 
            setStep(3, 'active');

            const payloadType = isEditMode ? "edit_pedido" : "pedido";

            const response = await fetch(URL_G, { 
                method: 'POST', 
                body: JSON.stringify({
                    tipo: payloadType,
                    numero: isEditMode ? editNum : undefined,
                    numeroCotizacion: numeroCot || null,
                    cedula: cedula,
                    nombre: nombre,
                    telefono: document.getElementById('telefono').value,
                    email: email,
                    direccion: document.getElementById('direccion').value,
                    descripcion: descripcionTexto, // üëà √çtems al tubo E
                    observaciones: notas,          // üëà Notas al tubo F
                    valorTotal: totalFinal,
                    abonoInicial: abonoInicial,
                    itemsJSON: JSON.stringify(itemsJSON), 
                    pdfBase64: pdfBase64,
                    nombreArchivo: nombreArchivo
                }) 
            });

            const result = await response.json();
            
            if (result.status === "success") {
                setStep(3, 'check'); 
                setStep(4, 'active');
                
                setTimeout(() => {
                    setStep(4, 'check');
                    pdf.save(nombreArchivo);
                    document.getElementById('loading').style.display = 'none';
                    
                    if(isEditMode) {
                        document.getElementById('exito-msg').innerText = "La orden fue actualizada en el sistema y el PDF ha sido reemplazado.";
                    }
                    
                    // Configurar bot√≥n de √©xito seg√∫n si hay migas de pan
                    const btnSuccess = document.getElementById('btn-success-home');
                    if (returnCedula) {
                        btnSuccess.setAttribute('onclick', `window.location.replace('clientes.html?search=${returnCedula}')`);
                        btnSuccess.innerHTML = '<i class="fas fa-user me-2"></i> Volver al Cliente';
                    } else {
                        btnSuccess.setAttribute('onclick', `window.location.replace('index.html')`);
                        btnSuccess.innerHTML = '<i class="fas fa-home me-2"></i> Volver al Men√∫';
                    }

                    document.getElementById('success-modal').style.display = 'flex';
                }, 800);
            } else { 
                throw new Error(result.msg || "El servidor no respondi√≥ con √©xito."); 
            }
        } catch (e) { 
            alert("Error: No se pudo procesar. Intenta nuevamente."); 
            console.error(e); 
            loading.style.display = 'none'; 
        }
    }

    // ===============================
    // 4. üîé SUGERENCIAS Y AUTOCOMPLETADO
    // ===============================
    document.getElementById("cedula").addEventListener("input", function() {
        buscarCliente(); 
        
        const valor = this.value.trim().toLowerCase(); 
        const cont = document.getElementById("sugerencias_cliente");
        
        cont.innerHTML = ""; 
        cont.style.display = "none";
        
        if (valor.length < 2) return;
        
        const cache = JSON.parse(localStorage.getItem("CACHE_CLIENTES") || "{}");
        
        Object.values(cache).forEach(cliente => {
            if (String(cliente.cedula).includes(valor) || cliente.nombre.toLowerCase().includes(valor)) {
                const div = document.createElement("div"); 
                div.style.padding = "12px 15px"; 
                div.style.cursor = "pointer"; 
                div.style.borderBottom = "1px solid #eee"; 
                div.style.fontSize = "0.85rem";
                div.onmouseover = () => div.style.background = "#f9f9f9"; 
                div.onmouseout = () => div.style.background = "white";
                div.innerHTML = `<strong style="color:var(--homeeasy-wine)">${cliente.cedula}</strong> - ${cliente.nombre}`;
                
                div.onclick = function() { 
                    document.getElementById("cedula").value = cliente.cedula; 
                    buscarCliente(); 
                    cont.innerHTML = ""; 
                    cont.style.display = "none"; 
                };
                
                cont.appendChild(div); 
                cont.style.display = "block";
            }
        });
    });

    document.addEventListener("click", function(e) { 
        const input = document.getElementById("cedula"); 
        const div = document.getElementById("sugerencias_cliente"); 
        if(e.target !== input && e.target !== div) { 
            div.style.display = "none"; 
        } 
    });

    function buscarCliente() {
        const ced = document.getElementById('cedula').value.trim(); 
        const cache = JSON.parse(localStorage.getItem("CACHE_CLIENTES") || "{}");
        
        if (!ced) { 
            document.getElementById('nombre').value = ""; 
            document.getElementById('telefono').value = ""; 
            document.getElementById('email').value = ""; 
            document.getElementById('direccion').value = ""; 
            return; 
        }
        
        if (cache[ced]) {
            const cliente = cache[ced];
            document.getElementById('nombre').value = (cliente.nombre || "").toUpperCase(); 
            document.getElementById('telefono').value = cliente.telefono || "";
            document.getElementById('email').value = (cliente.email || "").toLowerCase(); 
            document.getElementById('direccion').value = (cliente.direccion || "").toUpperCase();
        }
    }
</script>
</body>
</html>
