<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HomeEasy | Cotizaci√≥n</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- VARIABLES PREMIUM --- */
        :root { 
            --homeeasy-wine: #a6455a;  
            --homeeasy-gold: #c2a468;  
            --app-bg: #f8f9fa;
        }
        
        body { 
            background-color: var(--app-bg); 
            font-family: 'Montserrat', sans-serif; 
            color: #333; 
            margin: 0; 
            padding: 20px 10px;
        }
        
        .text-uppercase-input { text-transform: uppercase; }
        
        /* Bot√≥n Volver */
        .btn-back { 
            position: fixed; top: 15px; left: 15px; z-index: 1000; 
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px);
            border-radius: 50%; width: 45px; height: 45px; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); color: var(--homeeasy-wine); 
            text-decoration: none; font-size: 1.2rem; transition: transform 0.2s;
        }
        .btn-back:active { transform: scale(0.9); }
        
        /* Contenedor Principal (Aspecto de Papel F√≠sico) */
        #area-pdf { 
            background-color: white; 
            width: 100%; max-width: 800px; 
            margin: 0 auto; 
            min-height: 1035px; /* Proporci√≥n Carta */
            box-shadow: 0 15px 35px rgba(0,0,0,0.05); 
            border-radius: 12px; 
            overflow: hidden; 
            display: flex; flex-direction: column; 
            position: relative;
        }
        
        /* Cabecera del Documento */
        .header-brand { 
            background-color: var(--homeeasy-wine); 
            padding: 25px 35px 40px 35px; 
            display: flex; align-items: center; justify-content: space-between; 
            position: relative; 
        }
        .logo-only { max-width: 130px; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        .empresa-info-header { font-size: 0.75rem; color: #ffffff; text-align: right; line-height: 1.5; font-weight: 500;}
        .empresa-info-header b { color: var(--homeeasy-gold); font-size: 0.85rem; font-weight: 800; letter-spacing: 0.5px;}
        .empresa-info-header i { color: var(--homeeasy-gold); width: 18px; text-align: center; margin-right: 4px; }

        /* Meta Etiqueta Flotante */
        .order-meta { 
            position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); 
            background: white; padding: 10px 25px; border-radius: 30px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; 
            display: flex; gap: 20px; z-index: 10; white-space: nowrap; 
        }
        .meta-item { font-size: 0.7rem; font-weight: 800; color: var(--homeeasy-wine); text-transform: uppercase; letter-spacing: 0.5px;}

        /* T√≠tulo del Documento PREMIUM */
        .document-type { 
            background-color: #ffffff; 
            color: var(--homeeasy-wine); 
            text-align: center; 
            padding: 40px 12px 20px 12px; 
            font-weight: 300; 
            text-transform: uppercase; 
            letter-spacing: 8px; 
            border-bottom: 1px solid rgba(166, 69, 90, 0.1); 
            font-size: 1.6rem;
        }
        
        .card-body { padding: 30px 35px; flex-grow: 1; display: flex; flex-direction: column;}

        /* T√≠tulos de Secci√≥n */
        .section-title { 
            font-weight: 800; text-transform: uppercase; font-size: 0.8rem; 
            color: var(--homeeasy-wine); border-bottom: 2px solid #f0f0f0; 
            padding-bottom: 5px; margin-bottom: 15px; display: block; letter-spacing: 1px;
        }
        
        /* Campos de Formulario Premium */
        .form-label-small { font-size: 0.65rem; font-weight: 700; color: #aaa; text-transform: uppercase; margin-bottom: 2px; }
        .form-control-compact { 
            border: none; border-bottom: 1px solid #e0e0e0; border-radius: 0; 
            padding: 5px 0; font-size: 0.9rem; font-weight: 600; background: transparent; 
            width: 100%; transition: all 0.3s; color: #333;
        }
        .form-control-compact:focus { outline: none; border-bottom-color: var(--homeeasy-gold); box-shadow: none; }
        .form-control-compact::placeholder { color: #ccc; font-weight: 400; }

        /* Tabla Premium */
        .table { margin-bottom: 5px; }
        .table th { 
            font-size: 0.7rem; text-transform: uppercase; font-weight: 800; color: #555; 
            border-bottom: 2px solid var(--homeeasy-wine) !important; padding: 10px 5px; 
        }
        .table td { padding: 8px 5px; border-bottom: 1px solid #f5f5f5; vertical-align: middle;}
        
        /* Caja Financiera y Descuento */
        .finance-box { 
            background-color: #fafafa; border-radius: 12px; padding: 20px; 
            border-left: 6px solid var(--homeeasy-gold); height: 100%;
        }
        
        /* Bot√≥n Principal */
        .btn-homeeasy { 
            background-color: var(--homeeasy-wine); color: white; border: none; 
            font-weight: 800; padding: 18px; width: 100%; text-transform: uppercase; 
            border-radius: 12px; margin-top: 30px; font-size: 1rem; letter-spacing: 1px;
            box-shadow: 0 8px 20px rgba(166, 69, 90, 0.3); transition: transform 0.2s;
        }
        .btn-homeeasy:active { transform: scale(0.98); }
        
        /* Footer del Documento */
        .pdf-footer { 
            background-color: #fafafa; padding: 20px; text-align: center; 
            border-top: 1px solid #eee; margin-top: auto; 
        }
        .footer-logo { max-width: 80px; opacity: 0.4; margin-bottom: 10px; filter: grayscale(100%); }
        .footer-creds { font-size: 0.65rem; color: #777; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; }

        /* =========================================
           MODO EXPORTACI√ìN (COMPRIME ESPACIOS)
           ========================================= */
        .pdf-export-mode .header-brand { padding: 15px 30px 25px 30px !important; }
        .pdf-export-mode .document-type { padding: 25px 12px 10px 12px !important; font-size: 1.4rem !important; }
        .pdf-export-mode .card-body { padding: 15px 30px !important; }
        .pdf-export-mode .finance-box { padding: 10px 20px !important; }
        .pdf-export-mode .section-title { margin-bottom: 5px !important; }
        .pdf-export-mode .row.g-4 { row-gap: 0.5rem !important; }
        .pdf-export-mode .mb-5 { margin-bottom: 0.8rem !important; }
        .pdf-export-mode .mb-4 { margin-bottom: 0.5rem !important; }
        .pdf-export-mode .table th, .pdf-export-mode .table td { padding: 6px 5px !important; }
        .pdf-export-mode .pdf-footer { padding: 10px !important; }

        /* Pantalla de Carga */
        .loading-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            z-index: 9999; justify-content: center; align-items: center; 
        }
        .glass-loader { 
            background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.5); 
            border-radius: 25px; padding: 35px 30px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); 
            text-align: center; width: 85%; max-width: 340px; 
        }
        .hommy-loader { width: 140px; height: auto; margin-bottom: 15px; animation: bounce 2s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .step-item { font-size: 0.85rem; color: #777; font-weight: 600; opacity: 0.4; transition: all 0.3s; margin-bottom: 10px; display: flex; align-items: center; justify-content: start; gap: 10px; }
        .step-active { opacity: 1; color: var(--homeeasy-wine); font-weight: 800; }
        .step-check { opacity: 1; color: #2ecc71; font-weight: 700; }

        .row-desc, #notas { height: auto !important; min-height: 35px; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div class="glass-loader">
        <img src="hommysaludando.png" class="hommy-loader" alt="Hommy" onerror="this.src='HOMMY.png'">
        <h6 style="color:var(--homeeasy-wine); font-weight: 800; letter-spacing: 1px; margin-bottom: 5px;">PROCESANDO...</h6>
        <p class="small text-muted mb-4">Ajustando dise√±o de p√°gina perfecta</p>
        
        <div id="status-list" style="text-align: left; margin-left: 10px;">
            <div id="step-1" class="step-item"><i class="far fa-circle"></i> Escalando lienzo sin bordes...</div>
            <div id="step-2" class="step-item"><i class="far fa-circle"></i> Generando archivo PDF (4K)...</div>
            <div id="step-3" class="step-item"><i class="far fa-circle"></i> Guardando en la nube...</div>
            <div id="step-4" class="step-item"><i class="far fa-circle"></i> Finalizando...</div>
        </div>
    </div>
</div>

<a href="index.html" class="btn-back no-print"><i class="fas fa-arrow-left"></i></a>

<div id="area-pdf">
    <div class="header-brand">
        <img src="logohomeeasy.png" class="logo-only" alt="HomeEasy" onerror="this.src='triangulogold.png'; this.style.width='60px'">
        <div class="empresa-info-header">
            <b>HOMEEASY POPAY√ÅN</b><br>
            <span>NIT: 1.061.760.850-1</span><br>
            <span><i class="fas fa-map-marker-alt"></i> Trav. 9 # 6N-26</span><br>
            <span><i class="fas fa-phone-alt"></i> 3334319374</span><br>
            <span><i class="fab fa-instagram"></i> @homeeasypopayan</span>
        </div>
        <div class="order-meta">
            <div class="meta-item">COTIZACI√ìN N¬∞: <span id="n_cot_display" style="color: #333;">...</span></div>
            <div class="meta-item">Fecha: <span id="fecha_display" style="color: #333;"></span></div>
        </div>
    </div>
    
    <div class="document-type">COTIZACI√ìN</div>
    
    <div class="card-body">
        
        <span class="section-title">Informaci√≥n del Cliente</span>
        <div class="row g-3 mb-4">
            <div class="col-4">
                <label class="form-label-small">C√©dula / NIT</label>
                <input type="text" id="cedula" inputmode="numeric" class="form-control-compact" placeholder="Buscar..." autocomplete="off">
                <div id="sugerencias_cliente" style="background:white; border-radius:10px; max-height:200px; overflow:auto; box-shadow:0 10px 20px rgba(0,0,0,0.15); margin-top:5px; display:none; position: absolute; z-index: 100; width: 90%;"></div>
            </div>
            <div class="col-8">
                <label class="form-label-small">Nombre Completo</label>
                <input type="text" id="nombre" class="form-control-compact text-uppercase-input" oninput="capFirst(this)">
            </div>
            <div class="col-4">
                <label class="form-label-small">Tel√©fono</label>
                <input type="tel" id="telefono" inputmode="numeric" class="form-control-compact">
            </div>
            <div class="col-8">
                <label class="form-label-small">Correo Electr√≥nico</label>
                <input type="email" id="email" class="form-control-compact" style="text-transform: lowercase;">
            </div>
            <div class="col-12">
                <label class="form-label-small">Direcci√≥n / Ciudad</label>
                <input type="text" id="direccion" class="form-control-compact text-uppercase-input" oninput="capFirst(this)">
            </div>
        </div>

        <span class="section-title mt-2">Detalle de Productos</span>
        <div class="table-responsive" style="overflow-x: visible;">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>Descripci√≥n del Art√≠culo</th>
                        <th width="70" class="text-center">Cant.</th>
                        <th width="130" class="text-center">V. Unitario</th>
                        <th width="130" class="text-end">V. Total</th>
                        <th width="30" class="no-print"></th>
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    <tr>
                        <td><input type="text" class="form-control-compact row-desc" placeholder="Ej: Cortina enrollable blackout" oninput="capFirst(this)"></td>
                        <td><input type="number" class="form-control-compact text-center cant" value="1" inputmode="numeric" oninput="calcular()"></td>
                        <td><input type="text" class="form-control-compact text-center precio" placeholder="$ 0" inputmode="numeric" oninput="formatear(this); calcular()"></td>
                        <td class="item-total fw-bold text-end" style="color: var(--homeeasy-wine);">$ 0</td>
                        <td class="no-print text-end"><button class="btn btn-sm" style="color:#e74c3c; padding:0;" onclick="eliminarFila(this)"><i class="fas fa-times"></i></button></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button class="btn btn-sm no-print mb-4" style="background: rgba(194, 164, 104, 0.15); color: var(--homeeasy-gold); font-weight: 700; border-radius: 8px;" onclick="agregarFila()">+ A√±adir L√≠nea</button>

        <div class="mb-4">
            <label class="form-label-small">Observaciones Especiales</label>
            <textarea id="notas" class="form-control-compact" style="height: 40px; resize: none;" placeholder="Ej: Las medidas son aproximadas..." oninput="capFirst(this)"></textarea>
        </div>

        <div class="row g-4 mt-auto">
            <div class="col-md-6 col-12 d-flex flex-column justify-content-end">
                <span class="section-title mb-2">Condiciones Comerciales</span>
                <div style="font-size: 0.75rem; color: #666; line-height: 1.6;">
                    ‚Ä¢ Validez de la oferta: <b>15 d√≠as calendario</b>.<br>
                    ‚Ä¢ Incluye <b>toma de medidas e instalaci√≥n GRATIS</b> (Popay√°n).<br>
                    ‚Ä¢ Forma de pago: 50% anticipo, 50% contra entrega.
                </div>
            </div>
            
            <div class="col-md-6 col-12">
                <div class="finance-box">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span style="font-size: 0.8rem; font-weight: 800; color: #888;">SUBTOTAL:</span>
                        <span id="subtotal_val" style="font-weight: 700; color: #555;">$ 0</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2" id="desc_row">
                        <span style="font-size: 0.8rem; font-weight: 800; color: var(--homeeasy-gold);">DESCUENTO:</span>
                        <input type="text" id="descuento_input" class="form-control-compact text-end p-0" style="width: 100px; font-weight: 800; color: #e74c3c; border-bottom: 1px dashed #e74c3c;" placeholder="-$ 0" inputmode="numeric" oninput="formatear(this); calcular()">
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-3" style="border-top: 2px solid #eaeaea;">
                        <span style="font-size: 1.1rem; font-weight: 800; color: var(--homeeasy-wine);">TOTAL:</span>
                        <span id="total_val" style="font-size: 1.4rem; font-weight: 800; color: var(--homeeasy-wine);">$ 0</span>
                    </div>
                </div>
            </div>
        </div>

        <button class="btn btn-homeeasy no-print" onclick="finalizar()"><i class="fas fa-cloud-upload-alt me-2"></i> Procesar Cotizaci√≥n</button>
    </div>

    <div class="pdf-footer">
        <img src="Hommypiedepagina.png" alt="Hommy" style="height: 35px; opacity: 0.5; margin-bottom: 8px;">
        <div class="footer-creds">HomeEasy - Viste tu hogar con estilo</div>
        <div style="font-size: 0.6rem; color: #aaa; margin-top: 5px;">Documento generado autom√°ticamente ‚Ä¢ Sistema Hommy V2.0</div>
    </div>
</div>

<script>
    const URL_G = "https://script.google.com/macros/s/AKfycbyZHaIe7hb28KKtaPBORASy_maSZ2co8dZFce44GQRiZGYg_6WoU7qn4qC-lYCQO6ZL/exec";

    window.onload = () => {
        document.getElementById('fecha_display').innerText = new Date().toLocaleDateString('es-CO');
        
        fetch(`${URL_G}?nextCotizacion=1`)
            .then(r => r.json())
            .then(d => { 
                if(d.status === "ok") {
                    document.getElementById("n_cot_display").innerText = d.nextCotizacion; 
                }
            });

        fetch(`${URL_G}?init=LOAD`)
            .then(r => r.json())
            .then(data => {
                if (data.status === "ok" && data.clientes) {
                    const clientesObj = {};
                    for (let i = 1; i < data.clientes.length; i++) {
                        const c = data.clientes[i];
                        if(c && c[0]) {
                            clientesObj[c[0]] = { cedula: c[0], nombre: c[1], telefono: c[2], email: c[3], direccion: c[4] };
                        }
                    }
                    localStorage.setItem("CACHE_CLIENTES", JSON.stringify(clientesObj));
                    buscarCliente(); 
                }
            }).catch(err => console.error("Error parchando cach√©:", err));
    };

    // Funci√≥n Inteligente para May√∫scula Inicial
    function capFirst(input) {
        let val = input.value;
        if (val.length > 0) {
            input.value = val.charAt(0).toUpperCase() + val.slice(1);
        }
    }

    function formatear(i) {
        let v = i.value.replace(/\D/g, "");
        i.value = v ? new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v) : "";
    }

    function calcular() {
        let subtotal = 0;
        document.querySelectorAll('#tabla-body tr').forEach(tr => {
            let c = parseFloat(tr.querySelector('.cant').value) || 0;
            let p = parseFloat(tr.querySelector('.precio').value.replace(/\D/g, "")) || 0;
            let sub = c * p;
            tr.querySelector('.item-total').innerText = `$ ${sub.toLocaleString('es-CO')}`;
            subtotal += sub;
        });
        
        document.getElementById('subtotal_val').innerText = `$ ${subtotal.toLocaleString('es-CO')}`;
        
        let descInput = document.getElementById('descuento_input').value;
        let descuento = parseFloat(descInput.replace(/\D/g, "")) || 0;
        
        let totalFinal = subtotal - descuento;
        if(totalFinal < 0) totalFinal = 0; 
        
        document.getElementById('total_val').innerText = `$ ${totalFinal.toLocaleString('es-CO')}`;
    }

    function agregarFila() {
        let tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="form-control-compact row-desc" placeholder="Descripci√≥n..." oninput="capFirst(this)"></td>
            <td><input type="number" class="form-control-compact text-center cant" value="1" inputmode="numeric" oninput="calcular()"></td>
            <td><input type="text" class="form-control-compact text-center precio" placeholder="$ 0" inputmode="numeric" oninput="formatear(this); calcular()"></td>
            <td class="item-total fw-bold text-end" style="color: var(--homeeasy-wine);">$ 0</td>
            <td class="no-print text-end"><button class="btn btn-sm" style="color:#e74c3c; padding:0;" onclick="eliminarFila(this)"><i class="fas fa-times"></i></button></td>
        `;
        document.getElementById('tabla-body').appendChild(tr);
    }
    
    function eliminarFila(btn) {
        btn.closest('tr').remove();
        calcular();
    }

    function setStep(num, status) {
        const step = document.getElementById('step-' + num);
        if (status === 'active') {
            step.classList.add('step-active');
            step.innerHTML = `<i class="fas fa-circle-notch fa-spin text-warning"></i> ` + step.innerText.split(' ').slice(1).join(' ');
        } else if (status === 'check') {
            step.classList.remove('step-active');
            step.classList.add('step-check');
            step.innerHTML = `<i class="fas fa-check-circle"></i> ` + step.innerText;
        }
    }

    // ============================================================
    // üñ®Ô∏è MOTOR GENERADOR DE PDF CERO BORDES (EXTERMINADOR DEFINITIVO)
    // ============================================================
    async function finalizar() {
        const cedula = document.getElementById('cedula').value.trim();
        let nombre = document.getElementById('nombre').value.toUpperCase();
        let email = document.getElementById('email').value.toLowerCase();
        let numeroCot = document.getElementById("n_cot_display").innerText.trim() || "0";

        if (!cedula || !nombre) return alert("Por favor, ingresa al menos C√©dula y Nombre.");

        const loading = document.getElementById('loading');
        loading.style.display = 'flex';
        
        for(let i=1; i<=4; i++) {
            document.getElementById('step-'+i).className = 'step-item';
        }

        try {
            setStep(1, 'active');
            
            // TRUCO MAESTRO: Forzar al body a no tener padding para evitar m√°rgenes falsos en m√≥viles
            const origBodyPadding = document.body.style.padding;
            document.body.style.padding = '0';

            const areaPdf = document.getElementById('area-pdf');
            areaPdf.classList.add('pdf-export-mode');

            // Quitar bordes para la foto
            const origBorderRadius = areaPdf.style.borderRadius;
            const origBoxShadow = areaPdf.style.boxShadow;
            areaPdf.style.borderRadius = '0px';
            areaPdf.style.boxShadow = 'none';
            areaPdf.style.width = '800px';
            areaPdf.style.maxWidth = '800px';
            areaPdf.style.margin = '0'; // Cero m√°rgenes f√≠sicos

            // Dejar que el navegador renderice el cambio de tama√±o
            await new Promise(r => setTimeout(r, 50));

            const canvas = await html2canvas(areaPdf, { 
                scale: 3, // CALIDAD EXTREMA 4K
                useCORS: true, 
                width: 800,
                windowWidth: 800,
                x: areaPdf.offsetLeft, // Iniciar captura exactamente donde arranca el div
                y: areaPdf.offsetTop,
                onclone: function(clonedDoc) {
                    // 1. Eliminar botones no print
                    clonedDoc.querySelectorAll('.no-print').forEach(el => el.remove());

                    // 2. Eliminar filas vac√≠as
                    clonedDoc.querySelectorAll('#tabla-body tr').forEach(f => {
                        const desc = f.querySelector('.row-desc');
                        if(!desc || !desc.value.trim()) f.remove();
                    });

                    // 3. EXTERMINIO DEL DESCUENTO (Bypass al important de Bootstrap)
                    const descInput = clonedDoc.getElementById('descuento_input');
                    const descRow = clonedDoc.getElementById('desc_row');
                    if (descInput && descRow) {
                        const descVal = parseFloat(descInput.value.replace(/\D/g, ""));
                        // Si est√° vac√≠o, NaN o 0 -> SE ELIMINA LA FILA COMPLETA
                        if (isNaN(descVal) || descVal === 0) {
                            descRow.parentNode.removeChild(descRow); 
                        } else {
                            descInput.style.border = 'none'; 
                        }
                    }

                    // 4. Limpieza Inputs para PDF
                    clonedDoc.querySelectorAll('.form-control-compact').forEach(input => {
                        input.style.borderBottom = 'none';
                        input.style.background = 'transparent';
                        input.style.color = '#222';
                    });

                    // 5. Transformar inputs en texto
                    clonedDoc.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], input[type="number"]').forEach(input => {
                        const span = clonedDoc.createElement('span');
                        span.innerText = input.value;
                        span.className = input.className;
                        span.style.display = 'inline-block';
                        span.style.border = 'none';
                        span.style.background = 'transparent';
                        if(input.classList.contains('text-end')) span.style.textAlign = 'right';
                        if(input.classList.contains('text-center')) span.style.textAlign = 'center';
                        input.parentNode.replaceChild(span, input);
                    });

                    clonedDoc.querySelectorAll('textarea').forEach(ta => {
                        const div = clonedDoc.createElement('div');
                        div.innerText = ta.value;
                        div.className = ta.className;
                        div.style.border = 'none';
                        div.style.background = 'transparent';
                        div.style.whiteSpace = 'pre-wrap';
                        ta.parentNode.replaceChild(div, ta);
                    });
                }
            });

            setStep(1, 'check');
            setStep(2, 'active');

            // --- RESTAURAR INTERFAZ AL USUARIO M√ìVIL ---
            areaPdf.classList.remove('pdf-export-mode');
            document.body.style.padding = origBodyPadding; // Devolver padding original
            areaPdf.style.borderRadius = origBorderRadius;
            areaPdf.style.boxShadow = origBoxShadow;
            areaPdf.style.width = '100%';
            areaPdf.style.margin = '0 auto';

            // --- ARMADO DEL DOCUMENTO PDF CARTA ---
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "mm", "letter"); 
            
            const pdfWidth = pdf.internal.pageSize.getWidth(); 
            const pdfHeight = pdf.internal.pageSize.getHeight(); 
            const canvasRatio = canvas.width / canvas.height;
            
            const finalWidth = pdfWidth; // Exactamente el ancho del papel Carta
            let finalHeight = finalWidth / canvasRatio; 

            const imgData = canvas.toDataURL("image/jpeg", 1.0); // Calidad M√°xima
            
            let heightLeft = finalHeight;
            let position = 0;

            // Foto abarca TODO el ancho del PDF (X=0)
            pdf.addImage(imgData, "JPEG", 0, position, finalWidth, finalHeight);
            heightLeft -= pdfHeight;

            // Paginaci√≥n si hay muchos productos
            while (heightLeft > 0) {
                position -= pdfHeight; 
                pdf.addPage();
                pdf.addImage(imgData, "JPEG", 0, position, finalWidth, finalHeight);
                heightLeft -= pdfHeight;
            }

            const pdfBase64 = pdf.output('datauristring').split(',')[1];

            // --- GUARDADO EN BASE DE DATOS ---
            let descripcionTexto = "";
            let itemsJSON = [];
            document.querySelectorAll('#tabla-body tr').forEach(tr => {
                let descripcion = tr.querySelector('.row-desc').value.trim();
                let cantidad = parseFloat(tr.querySelector('.cant').value) || 0;
                let precio = parseFloat(tr.querySelector('.precio').value.replace(/\D/g, "")) || 0;
                if (!descripcion) return;
                descripcionTexto += `${cantidad} x ${descripcion} / `;
                itemsJSON.push({ descripcion: descripcion, cantidad: cantidad, precio: precio, subtotal: cantidad * precio });
            });

            const totalFinal = document.getElementById('total_val').innerText.replace(/\D/g, "");
            const nombreArchivo = `Cotizacion_N_${numeroCot}_${cedula}.pdf`;

            setStep(2, 'check');
            setStep(3, 'active');

            const response = await fetch(URL_G, { 
                method: 'POST', 
                body: JSON.stringify({
                    tipo: "cotizacion",
                    cedula: cedula,
                    nombre: nombre,
                    telefono: document.getElementById('telefono').value,
                    email: email,
                    direccion: document.getElementById('direccion').value,
                    descripcion: descripcionTexto,
                    total: totalFinal,
                    items: itemsJSON,
                    observaciones: document.getElementById('notas').value,
                    pdfBase64: pdfBase64,
                    nombreArchivo: nombreArchivo
                }) 
            });

            const result = await response.json();
            
            if (result.status === "success") {
                setStep(3, 'check');
                setStep(4, 'active');
                
                pdf.save(nombreArchivo);

                setTimeout(() => {
                    setStep(4, 'check');
                    setTimeout(() => {
                        window.location.replace("index.html");
                    }, 800);
                }, 800);
            } else {
                throw new Error("El servidor no respondi√≥ con √©xito.");
            }
        } catch (e) {
            alert("Error: No se pudo procesar. Intenta nuevamente.");
            console.error(e);
            loading.style.display = 'none';
        }
    }

    // ===============================
    // üîé SUGERENCIAS Y AUTOCOMPLETADO
    // ===============================
    document.getElementById("cedula").addEventListener("input", function() {
        buscarCliente(); 

        const valor = this.value.trim().toLowerCase();
        const cont = document.getElementById("sugerencias_cliente");

        cont.innerHTML = "";
        cont.style.display = "none";

        if (valor.length < 2) return;

        const cache = JSON.parse(localStorage.getItem("CACHE_CLIENTES") || "{}");

        Object.values(cache).forEach(cliente => {
            if (String(cliente.cedula).includes(valor) || cliente.nombre.toLowerCase().includes(valor)) {
                const div = document.createElement("div");
                div.style.padding = "12px 15px";
                div.style.cursor = "pointer";
                div.style.borderBottom = "1px solid #eee";
                div.style.fontSize = "0.85rem";
                div.onmouseover = () => div.style.background = "#f9f9f9";
                div.onmouseout = () => div.style.background = "white";
                div.innerHTML = `<strong style="color:var(--homeeasy-wine)">${cliente.cedula}</strong> - ${cliente.nombre}`;

                div.onclick = function() {
                    document.getElementById("cedula").value = cliente.cedula;
                    buscarCliente();
                    cont.innerHTML = "";
                    cont.style.display = "none";
                };

                cont.appendChild(div);
                cont.style.display = "block";
            }
        });
    });

    document.addEventListener("click", function(e) {
        const input = document.getElementById("cedula");
        const div = document.getElementById("sugerencias_cliente");
        if(e.target !== input && e.target !== div) {
            div.style.display = "none";
        }
    });

    function buscarCliente() {
        const ced = document.getElementById('cedula').value.trim();
        const cache = JSON.parse(localStorage.getItem("CACHE_CLIENTES") || "{}");

        if (!ced) {
            document.getElementById('nombre').value = "";
            document.getElementById('telefono').value = "";
            document.getElementById('email').value = "";
            document.getElementById('direccion').value = "";
            return;
        }

        if (cache[ced]) {
            const cliente = cache[ced];
            document.getElementById('nombre').value = (cliente.nombre || "").toUpperCase();
            document.getElementById('telefono').value = cliente.telefono || "";
            document.getElementById('email').value = (cliente.email || "").toLowerCase();
            document.getElementById('direccion').value = (cliente.direccion || "").toUpperCase();
        }
    }
</script>
</body>
</html>
